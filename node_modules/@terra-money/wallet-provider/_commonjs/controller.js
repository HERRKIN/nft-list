"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WalletController = void 0;
const browser_check_1 = require("@terra-dev/browser-check");
const readonly_wallet_modal_1 = require("@terra-dev/readonly-wallet-modal");
const use_wallet_1 = require("@terra-dev/use-wallet");
const wallet_types_1 = require("@terra-dev/wallet-types");
const web_connector_controller_1 = require("@terra-dev/web-connector-controller");
const web_connector_interface_1 = require("@terra-dev/web-connector-interface");
const terra_js_1 = require("@terra-money/terra.js");
const fast_deep_equal_1 = __importDefault(require("fast-deep-equal"));
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const env_1 = require("./env");
const chrome_extension_1 = require("./modules/chrome-extension");
const readonly_wallet_1 = require("./modules/readonly-wallet");
const walletconnect_1 = require("./modules/walletconnect");
const checkAvailableExtension_1 = require("./utils/checkAvailableExtension");
const defaultWaitingChromeExtensionInstallCheck = 1000 * 3;
class WalletController {
    constructor(options) {
        var _a;
        this.options = options;
        this.chromeExtension = null;
        this.webConnector = null;
        this.walletConnect = null;
        this.readonlyWallet = null;
        this.disableReadonlyWallet = null;
        this.disableChromeExtension = null;
        this.disableWebExtension = null;
        this.disableWalletConnect = null;
        /** @see Wallet#isChromeExtensionCompatibleBrowser */
        this.isChromeExtensionCompatibleBrowser = () => {
            var _a;
            return ((_a = this.options.dangerously__chromeExtensionCompatibleBrowserCheck) !== null && _a !== void 0 ? _a : env_1.DEFAULT_CHROME_EXTENSION_COMPATIBLE_BROWSER_CHECK)(navigator.userAgent);
        };
        /** @see Wallet#availableConnectTypes */
        this.availableConnectTypes = () => {
            return this._availableConnectTypes.asObservable();
        };
        /** @see Wallet#availableInstallTypes */
        this.availableInstallTypes = () => {
            return this._availableInstallTypes.asObservable();
        };
        /**
         * @see Wallet#status
         * @see Wallet#network
         * @see Wallet#wallets
         */
        this.states = () => {
            return this._states.asObservable();
        };
        /** @deprecated please use `states()` */
        this.status = () => {
            return this._states.pipe(operators_1.map((data) => data.status));
        };
        /** @deprecated please use `states()` */
        this.network = () => {
            return this._states.pipe(operators_1.map((data) => data.network));
        };
        /** @deprecated please use `states()` */
        this.wallets = () => {
            return this._states.pipe(operators_1.map((data) => data.status === use_wallet_1.WalletStatus.WALLET_CONNECTED ? data.wallets : []));
        };
        /** @see Wallet#recheckStatus */
        this.recheckStatus = () => {
            var _a;
            if (this.disableChromeExtension) {
                (_a = this.chromeExtension) === null || _a === void 0 ? void 0 : _a.recheckStatus();
            }
        };
        /** @see Wallet#install */
        this.install = (type) => {
            var _a;
            if (type === use_wallet_1.ConnectType.CHROME_EXTENSION) {
                window.open(env_1.CHROME_EXTENSION_INSTALL_URL, '_blank');
            }
            else if (type === use_wallet_1.ConnectType.WEB_CONNECT) {
                const webExtensionStatus = (_a = this.webConnector) === null || _a === void 0 ? void 0 : _a.getLastStatus();
                if ((webExtensionStatus === null || webExtensionStatus === void 0 ? void 0 : webExtensionStatus.type) === web_connector_interface_1.WebConnectorStatusType.NO_AVAILABLE &&
                    webExtensionStatus.installLink) {
                    window.open(webExtensionStatus.installLink, '_blank');
                }
            }
            else {
                console.warn(`ConnectType "${type}" does not support install() function`);
            }
        };
        /** @see Wallet#connect */
        this.connect = (type) => {
            var _a, _b, _c;
            switch (type) {
                case use_wallet_1.ConnectType.READONLY:
                    const networks = Object.keys(this.options.walletConnectChainIds).map((chainId) => this.options.walletConnectChainIds[+chainId]);
                    const createReadonlyWalletSession = (_c = (_b = (_a = this.options).createReadonlyWalletSession) === null || _b === void 0 ? void 0 : _b.call(_a, networks)) !== null && _c !== void 0 ? _c : readonly_wallet_modal_1.readonlyWalletModal({ networks });
                    createReadonlyWalletSession.then((readonlyWalletSession) => {
                        if (readonlyWalletSession) {
                            this.enableReadonlyWallet(readonly_wallet_1.connect(readonlyWalletSession));
                        }
                    });
                    break;
                case use_wallet_1.ConnectType.WALLETCONNECT:
                    this.enableWalletConnect(walletconnect_1.connect(this.options));
                    break;
                case use_wallet_1.ConnectType.CHROME_EXTENSION:
                    this.chromeExtension.connect().then((success) => {
                        if (success) {
                            this.enableChromeExtension();
                        }
                    });
                    break;
                case use_wallet_1.ConnectType.WEB_CONNECT:
                    this.enableWebExtension();
                    break;
                default:
                    throw new Error(`Unknown ConnectType!`);
            }
        };
        /** @see Wallet#connectReadonly */
        this.connectReadonly = (terraAddress, network) => {
            this.enableReadonlyWallet(readonly_wallet_1.connect({
                terraAddress,
                network,
            }));
        };
        /** @see Wallet#disconnect */
        this.disconnect = () => {
            var _a, _b, _c, _d;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            this.disableReadonlyWallet = null;
            (_b = this.disableChromeExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            this.disableChromeExtension = null;
            (_c = this.disableWebExtension) === null || _c === void 0 ? void 0 : _c.call(this);
            this.disableWebExtension = null;
            (_d = this.disableWalletConnect) === null || _d === void 0 ? void 0 : _d.call(this);
            this.disableWalletConnect = null;
            localStorage.removeItem(env_1.WEB_EXTENSION_CONNECTED_KEY);
            this.updateStates(this._notConnected);
        };
        /** @see Wallet#post */
        this.post = async (tx, 
        // TODO not work at this time. for the future extension
        txTarget = {}) => {
            // ---------------------------------------------
            // chrome extension - legacy extension
            // ---------------------------------------------
            if (this.disableChromeExtension) {
                if (!this.chromeExtension) {
                    throw new Error(`chromeExtension instance not created!`);
                }
                return (this.chromeExtension
                    // TODO make WalletConnectTxResult to common type
                    .post(tx)
                    .then(({ payload }) => {
                    return {
                        ...tx,
                        result: payload.result,
                        success: true,
                    };
                })
                    .catch((error) => {
                    if (error instanceof chrome_extension_1.ChromeExtensionCreateTxFailed) {
                        throw new wallet_types_1.CreateTxFailed(tx, error.message);
                    }
                    else if (error instanceof chrome_extension_1.ChromeExtensionTxFailed) {
                        throw new wallet_types_1.TxFailed(tx, error.txhash, error.message, null);
                    }
                    else if (error instanceof chrome_extension_1.ChromeExtensionUnspecifiedError) {
                        throw new wallet_types_1.TxUnspecifiedError(tx, error.message);
                    }
                    // UserDeniedError
                    // All unspecified errors...
                    throw error;
                }));
            }
            // ---------------------------------------------
            // web extension - new extension
            // ---------------------------------------------
            else if (this.disableWebExtension) {
                return new Promise((resolve, reject) => {
                    var _a, _b;
                    if (!this.webConnector) {
                        reject(new Error(`webExtension instance not created!`));
                        return;
                    }
                    const webExtensionStates = this.webConnector.getLastStates();
                    if (!webExtensionStates) {
                        reject(new Error(`webExtension.getLastStates() returns undefined!`));
                        return;
                    }
                    const focusedWallet = txTarget.terraAddress
                        ? (_a = webExtensionStates.wallets.find((itemWallet) => itemWallet.terraAddress === txTarget.terraAddress)) !== null && _a !== void 0 ? _a : webExtensionStates.wallets[0]
                        : webExtensionStates.focusedWalletAddress
                            ? (_b = webExtensionStates.wallets.find((itemWallet) => itemWallet.terraAddress ===
                                webExtensionStates.focusedWalletAddress)) !== null && _b !== void 0 ? _b : webExtensionStates.wallets[0]
                            : webExtensionStates.wallets[0];
                    const subscription = this.webConnector
                        .post(focusedWallet.terraAddress, tx)
                        .subscribe({
                        next: (extensionTxResult) => {
                            switch (extensionTxResult.status) {
                                case web_connector_interface_1.WebConnectorTxStatus.SUCCEED:
                                    resolve({
                                        ...tx,
                                        result: extensionTxResult.payload,
                                        success: true,
                                    });
                                    subscription.unsubscribe();
                                    break;
                            }
                        },
                        error: (error) => {
                            if (error instanceof web_connector_interface_1.WebConnectorUserDenied) {
                                reject(new wallet_types_1.UserDenied());
                            }
                            else if (error instanceof web_connector_interface_1.WebConnectorCreateTxFailed) {
                                reject(new wallet_types_1.CreateTxFailed(tx, error.message));
                            }
                            else if (error instanceof web_connector_interface_1.WebConnectorTxFailed) {
                                reject(new wallet_types_1.TxFailed(tx, error.txhash, error.message, error.raw_message));
                            }
                            else {
                                reject(new wallet_types_1.TxUnspecifiedError(tx, 'message' in error ? error.message : String(error)));
                            }
                            subscription.unsubscribe();
                        },
                    });
                });
            }
            // ---------------------------------------------
            // wallet connect
            // ---------------------------------------------
            else if (this.walletConnect) {
                return this.walletConnect
                    .post(tx)
                    .then((result) => ({
                    ...tx,
                    result,
                    success: true,
                }))
                    .catch((error) => {
                    let throwError = error;
                    try {
                        if (error instanceof walletconnect_1.WalletConnectUserDenied) {
                            throwError = new wallet_types_1.UserDenied();
                        }
                        else if (error instanceof walletconnect_1.WalletConnectCreateTxFailed) {
                            throwError = new wallet_types_1.CreateTxFailed(tx, error.message);
                        }
                        else if (error instanceof walletconnect_1.WalletConnectTxFailed) {
                            throwError = new wallet_types_1.TxFailed(tx, error.txhash, error.message, error.raw_message);
                        }
                        else if (error instanceof walletconnect_1.WalletConnectTimeout) {
                            throwError = new wallet_types_1.Timeout(error.message);
                        }
                        else if (error instanceof walletconnect_1.WalletConnectTxUnspecifiedError) {
                            throwError = new wallet_types_1.TxUnspecifiedError(tx, error.message);
                        }
                    }
                    catch (_a) {
                        throwError = new wallet_types_1.TxUnspecifiedError(tx, 'message' in error ? error.message : String(error));
                    }
                    throw throwError;
                });
            }
            else {
                throw new Error(`There are no connections that can be posting tx!`);
            }
        };
        /** @see Wallet#sign */
        this.sign = async (tx, 
        // TODO not work at this time. for the future extension
        txTarget = {}) => {
            if (this.disableChromeExtension) {
                if (!this.chromeExtension) {
                    throw new Error(`chromeExtension instance not created!`);
                }
                return this.chromeExtension
                    .sign(tx)
                    .then(({ payload }) => {
                    const publicKey = typeof payload.result.public_key === 'string'
                        ? {
                            type: 'tendermint/PubKeySecp256k1',
                            value: payload.result.public_key,
                        }
                        : payload.result.public_key;
                    const signResult = {
                        ...payload.result,
                        public_key: publicKey,
                    };
                    return {
                        ...tx,
                        result: signResult,
                        success: true,
                    };
                })
                    .catch((error) => {
                    if (error instanceof chrome_extension_1.ChromeExtensionCreateTxFailed) {
                        throw new wallet_types_1.CreateTxFailed(tx, error.message);
                    }
                    else if (error instanceof chrome_extension_1.ChromeExtensionTxFailed) {
                        throw new wallet_types_1.TxFailed(tx, error.txhash, error.message, null);
                    }
                    else if (error instanceof chrome_extension_1.ChromeExtensionUnspecifiedError) {
                        throw new wallet_types_1.TxUnspecifiedError(tx, error.message);
                    }
                    // UserDenied - chrome extension will sent original UserDenied error type
                    // All unspecified errors...
                    throw error;
                });
            }
            throw new Error(`sign() method only available on chrome extension`);
            // TODO implements sign() to other connect types
        };
        // ================================================================
        // internal
        // connect type changing
        // ================================================================
        this.updateStates = (next) => {
            const prev = this._states.getValue();
            if (next.status === use_wallet_1.WalletStatus.WALLET_CONNECTED &&
                next.wallets.length === 0) {
                console.trace('???');
            }
            if (prev.status !== next.status || !fast_deep_equal_1.default(prev, next)) {
                this._states.next(next);
            }
        };
        this.enableReadonlyWallet = (readonlyWallet) => {
            var _a, _b, _c, _d;
            (_a = this.disableWalletConnect) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableChromeExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            (_c = this.disableWebExtension) === null || _c === void 0 ? void 0 : _c.call(this);
            if (this.readonlyWallet === readonlyWallet ||
                (((_d = this.readonlyWallet) === null || _d === void 0 ? void 0 : _d.terraAddress) === readonlyWallet.terraAddress &&
                    this.readonlyWallet.network === readonlyWallet.network)) {
                return;
            }
            if (this.readonlyWallet) {
                this.readonlyWallet.disconnect();
            }
            this.readonlyWallet = readonlyWallet;
            this.updateStates({
                status: use_wallet_1.WalletStatus.WALLET_CONNECTED,
                network: readonlyWallet.network,
                wallets: [
                    {
                        connectType: use_wallet_1.ConnectType.READONLY,
                        terraAddress: readonlyWallet.terraAddress,
                        design: 'readonly',
                    },
                ],
            });
            this.disableReadonlyWallet = () => {
                readonlyWallet.disconnect();
                this.readonlyWallet = null;
                this.disableReadonlyWallet = null;
            };
        };
        this.enableWebExtension = () => {
            var _a, _b, _c;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableWalletConnect) === null || _b === void 0 ? void 0 : _b.call(this);
            (_c = this.disableChromeExtension) === null || _c === void 0 ? void 0 : _c.call(this);
            if (this.disableWebExtension || !this.webConnector) {
                return;
            }
            const extensionSubscription = rxjs_1.combineLatest([
                this.webConnector.status(),
                this.webConnector.states(),
            ]).subscribe(([status, states]) => {
                var _a;
                if (!states) {
                    return;
                }
                if (status.type === web_connector_interface_1.WebConnectorStatusType.READY) {
                    if (states.wallets.length > 0) {
                        const focusedWallet = states.focusedWalletAddress
                            ? (_a = states.wallets.find((itemWallet) => itemWallet.terraAddress === states.focusedWalletAddress)) !== null && _a !== void 0 ? _a : states.wallets[0]
                            : states.wallets[0];
                        this.updateStates({
                            status: use_wallet_1.WalletStatus.WALLET_CONNECTED,
                            network: states.network,
                            wallets: [
                                {
                                    connectType: use_wallet_1.ConnectType.WEB_CONNECT,
                                    terraAddress: focusedWallet.terraAddress,
                                    design: focusedWallet.design,
                                },
                            ],
                        });
                    }
                }
                else if (status.type === web_connector_interface_1.WebConnectorStatusType.NO_AVAILABLE) {
                    localStorage.removeItem(env_1.WEB_EXTENSION_CONNECTED_KEY);
                    this.updateStates(this._notConnected);
                    if (!status.isApproved && this.disableWebExtension) {
                        this.disableWebExtension();
                    }
                }
            });
            localStorage.setItem(env_1.WEB_EXTENSION_CONNECTED_KEY, 'true');
            const lastExtensionStatus = this.webConnector.getLastStatus();
            if (lastExtensionStatus.type === web_connector_interface_1.WebConnectorStatusType.NO_AVAILABLE &&
                lastExtensionStatus.isApproved === false) {
                this.webConnector.requestApproval();
            }
            this.disableWebExtension = () => {
                localStorage.removeItem(env_1.WEB_EXTENSION_CONNECTED_KEY);
                extensionSubscription.unsubscribe();
                this.disableWebExtension = null;
            };
        };
        this.enableChromeExtension = () => {
            var _a, _b, _c;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableWalletConnect) === null || _b === void 0 ? void 0 : _b.call(this);
            (_c = this.disableWebExtension) === null || _c === void 0 ? void 0 : _c.call(this);
            if (this.disableChromeExtension || !this.chromeExtension) {
                return;
            }
            const extensionSubscription = rxjs_1.combineLatest([
                this.chromeExtension.status(),
                this.chromeExtension.networkInfo(),
                this.chromeExtension.terraAddress(),
            ]).subscribe({
                next: ([status, networkInfo, terraAddress]) => {
                    if (status === chrome_extension_1.ChromeExtensionStatus.WALLET_CONNECTED &&
                        typeof terraAddress === 'string' &&
                        terra_js_1.AccAddress.validate(terraAddress)) {
                        this.updateStates({
                            status: use_wallet_1.WalletStatus.WALLET_CONNECTED,
                            network: networkInfo,
                            wallets: [
                                {
                                    connectType: use_wallet_1.ConnectType.CHROME_EXTENSION,
                                    terraAddress,
                                    design: 'extension',
                                },
                            ],
                        });
                    }
                    else {
                        this.updateStates(this._notConnected);
                    }
                },
            });
            this.disableChromeExtension = () => {
                var _a;
                (_a = this.chromeExtension) === null || _a === void 0 ? void 0 : _a.disconnect();
                extensionSubscription.unsubscribe();
                this.disableChromeExtension = null;
            };
        };
        this.enableWalletConnect = (walletConnect) => {
            var _a, _b, _c;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableChromeExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            (_c = this.disableWebExtension) === null || _c === void 0 ? void 0 : _c.call(this);
            if (this.walletConnect === walletConnect) {
                return;
            }
            if (this.walletConnect) {
                this.walletConnect.disconnect();
            }
            this.walletConnect = walletConnect;
            const subscribeWalletConnect = (wc) => {
                return wc.session().subscribe({
                    next: (status) => {
                        var _a;
                        switch (status.status) {
                            case walletconnect_1.WalletConnectSessionStatus.CONNECTED:
                                this.updateStates({
                                    status: use_wallet_1.WalletStatus.WALLET_CONNECTED,
                                    network: (_a = this.options.walletConnectChainIds[status.chainId]) !== null && _a !== void 0 ? _a : this.options.defaultNetwork,
                                    wallets: [
                                        {
                                            connectType: use_wallet_1.ConnectType.WALLETCONNECT,
                                            terraAddress: status.terraAddress,
                                            design: 'walletconnect',
                                        },
                                    ],
                                });
                                break;
                            default:
                                this.updateStates(this._notConnected);
                                break;
                        }
                    },
                });
            };
            const walletConnectSessionSubscription = subscribeWalletConnect(walletConnect);
            this.disableWalletConnect = () => {
                var _a;
                (_a = this.walletConnect) === null || _a === void 0 ? void 0 : _a.disconnect();
                this.walletConnect = null;
                walletConnectSessionSubscription.unsubscribe();
                this.disableWalletConnect = null;
            };
        };
        this._notConnected = {
            status: use_wallet_1.WalletStatus.WALLET_NOT_CONNECTED,
            network: options.defaultNetwork,
        };
        this._initializing = {
            status: use_wallet_1.WalletStatus.INITIALIZING,
            network: options.defaultNetwork,
        };
        this._availableConnectTypes = new rxjs_1.BehaviorSubject([
            use_wallet_1.ConnectType.READONLY,
            use_wallet_1.ConnectType.WALLETCONNECT,
        ]);
        this._availableInstallTypes = new rxjs_1.BehaviorSubject([]);
        this._states = new rxjs_1.BehaviorSubject(this._initializing);
        let numSessionCheck = 0;
        // wait checking the availability of the chrome extension
        // 0. check if extension wallet session is exists
        checkAvailableExtension_1.checkAvailableExtension((_a = options.waitingChromeExtensionInstallCheck) !== null && _a !== void 0 ? _a : defaultWaitingChromeExtensionInstallCheck, this.isChromeExtensionCompatibleBrowser()).then((extensionType) => {
            var _a;
            if (extensionType === use_wallet_1.ConnectType.WEB_CONNECT) {
                this._availableConnectTypes.next([
                    use_wallet_1.ConnectType.READONLY,
                    use_wallet_1.ConnectType.WEB_CONNECT,
                    use_wallet_1.ConnectType.WALLETCONNECT,
                ]);
                this.webConnector = new web_connector_controller_1.WebConnectorController(window);
                const subscription = this.webConnector
                    .status()
                    .pipe(operators_1.filter((webExtensionStatus) => {
                    return (webExtensionStatus.type !== web_connector_interface_1.WebConnectorStatusType.INITIALIZING);
                }))
                    .subscribe((webExtensionStatus) => {
                    subscription.unsubscribe();
                    if (webExtensionStatus.type === web_connector_interface_1.WebConnectorStatusType.READY &&
                        localStorage.getItem(env_1.WEB_EXTENSION_CONNECTED_KEY) === 'true' &&
                        !this.disableWalletConnect &&
                        !this.disableReadonlyWallet) {
                        this.enableWebExtension();
                    }
                    else if (numSessionCheck === 0) {
                        numSessionCheck += 1;
                    }
                    else {
                        this.updateStates(this._notConnected);
                        localStorage.removeItem(env_1.WEB_EXTENSION_CONNECTED_KEY);
                    }
                });
            }
            else if (extensionType === use_wallet_1.ConnectType.CHROME_EXTENSION) {
                this._availableConnectTypes.next([
                    use_wallet_1.ConnectType.READONLY,
                    use_wallet_1.ConnectType.CHROME_EXTENSION,
                    use_wallet_1.ConnectType.WALLETCONNECT,
                ]);
                this.chromeExtension = new chrome_extension_1.ChromeExtensionController({
                    enableWalletConnection: true,
                    defaultNetwork: options.defaultNetwork,
                    dangerously__chromeExtensionCompatibleBrowserCheck: (_a = options.dangerously__chromeExtensionCompatibleBrowserCheck) !== null && _a !== void 0 ? _a : env_1.DEFAULT_CHROME_EXTENSION_COMPATIBLE_BROWSER_CHECK,
                });
                const subscription = this.chromeExtension
                    .status()
                    .pipe(operators_1.filter((chromeExtensionStatus) => {
                    return (chromeExtensionStatus !== chrome_extension_1.ChromeExtensionStatus.INITIALIZING);
                }))
                    .subscribe((chromeExtensionStatus) => {
                    try {
                        subscription.unsubscribe();
                    }
                    catch (_a) { }
                    if (chromeExtensionStatus ===
                        chrome_extension_1.ChromeExtensionStatus.WALLET_CONNECTED &&
                        !this.disableWalletConnect &&
                        !this.disableReadonlyWallet) {
                        this.enableChromeExtension();
                    }
                    else if (numSessionCheck === 0) {
                        numSessionCheck += 1;
                    }
                    else {
                        this.updateStates(this._notConnected);
                    }
                });
            }
            else {
                if (browser_check_1.isDesktopChrome(this.isChromeExtensionCompatibleBrowser())) {
                    this._availableInstallTypes.next([use_wallet_1.ConnectType.CHROME_EXTENSION]);
                }
                if (numSessionCheck === 0) {
                    numSessionCheck += 1;
                }
                else {
                    this.updateStates(this._notConnected);
                }
            }
        });
        // 1. check if readonly wallet session is exists
        const draftReadonlyWallet = readonly_wallet_1.connectIfSessionExists();
        if (draftReadonlyWallet) {
            this.enableReadonlyWallet(draftReadonlyWallet);
            return;
        }
        // 2. check if walletconnect sesison is exists
        const draftWalletConnect = walletconnect_1.connectIfSessionExists(options);
        if (draftWalletConnect &&
            draftWalletConnect.getLatestSession().status ===
                walletconnect_1.WalletConnectSessionStatus.CONNECTED) {
            this.enableWalletConnect(draftWalletConnect);
        }
        else if (numSessionCheck === 0) {
            numSessionCheck += 1;
        }
        else {
            this.updateStates(this._notConnected);
        }
    }
}
exports.WalletController = WalletController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9AdGVycmEtbW9uZXkvd2FsbGV0LXByb3ZpZGVyL2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNERBQTJEO0FBQzNELDRFQUF1RTtBQUN2RSxzREFNK0I7QUFDL0IsMERBUWlDO0FBQ2pDLGtGQUE2RTtBQUM3RSxnRkFPNEM7QUFDNUMsb0RBSytCO0FBQy9CLHNFQUF3QztBQUN4QywrQkFBZ0Y7QUFDaEYsOENBQTZDO0FBQzdDLCtCQUllO0FBQ2YsaUVBTW9DO0FBQ3BDLCtEQUttQztBQUNuQywyREFZaUM7QUFDakMsNkVBQTBFO0FBeUUxRSxNQUFNLHlDQUF5QyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUM7QUFFM0QsTUFBYSxnQkFBZ0I7SUFrQjNCLFlBQXFCLE9BQWdDOztRQUFoQyxZQUFPLEdBQVAsT0FBTyxDQUF5QjtRQWpCN0Msb0JBQWUsR0FBcUMsSUFBSSxDQUFDO1FBQ3pELGlCQUFZLEdBQWtDLElBQUksQ0FBQztRQUNuRCxrQkFBYSxHQUFtQyxJQUFJLENBQUM7UUFDckQsbUJBQWMsR0FBb0MsSUFBSSxDQUFDO1FBTXZELDBCQUFxQixHQUF3QixJQUFJLENBQUM7UUFDbEQsMkJBQXNCLEdBQXdCLElBQUksQ0FBQztRQUNuRCx3QkFBbUIsR0FBd0IsSUFBSSxDQUFDO1FBQ2hELHlCQUFvQixHQUF3QixJQUFJLENBQUM7UUFvSnpELHFEQUFxRDtRQUNyRCx1Q0FBa0MsR0FBRyxHQUFZLEVBQUU7O1lBQ2pELE9BQU8sQ0FDTCxNQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsa0RBQWtELG1DQUMvRCx1REFBaUQsQ0FDbEQsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDO1FBRUYsd0NBQXdDO1FBQ3hDLDBCQUFxQixHQUFHLEdBQThCLEVBQUU7WUFDdEQsT0FBTyxJQUFJLENB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O2dCQUNMLElBQUksK0JBQWUsQ0FBQyxJQUFJLENBQUMsa0NBQWtDLEVBQUUsQ0FBQyxFQUFFO29CQUM5RCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUMsd0JBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7aUJBQ2xFO2dCQUVELElBQUksZUFBZSxLQUFLLENBQUMsRUFBRTtvQkFDekIsZUFBZSxJQUFJLENBQUMsQ0FBQztpQkFDdEI7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7aUJBQ3ZDO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILGdEQUFnRDtRQUNoRCxNQUFNLG1CQUFtQixHQUFHLHdDQUF3QixFQUFFLENBQUM7UUFFdkQsSUFBSSxtQkFBbUIsRUFBRTtZQUN2QixJQUFJLENBQUMsb0JBQW9CLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUMvQyxPQUFPO1NBQ1I7UUFFRCw4Q0FBOEM7UUFDOUMsTUFBTSxrQkFBa0IsR0FBRyxzQ0FBd0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3RCxJQUNFLGtCQUFrQjtZQUNsQixrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLE1BQU07Z0JBQzFDLDBDQUEwQixDQUFDLFNBQVMsRUFDdEM7WUFDQSxJQUFJLENBQUMsbUJBQW1CLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUM5QzthQUFNLElBQUksZUFBZSxLQUFLLENBQUMsRUFBRTtZQUNoQyxlQUFlLElBQUksQ0FBQyxDQUFDO1NBQ3RCO2FBQU07WUFDTCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN2QztJQUNILENBQUM7Q0Fna0JGO0FBL3RCRCw0Q0ErdEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNEZXNrdG9wQ2hyb21lIH0gZnJvbSAnQHRlcnJhLWRldi9icm93c2VyLWNoZWNrJztcbmltcG9ydCB7IHJlYWRvbmx5V2FsbGV0TW9kYWwgfSBmcm9tICdAdGVycmEtZGV2L3JlYWRvbmx5LXdhbGxldC1tb2RhbCc7XG5pbXBvcnQge1xuICBDb25uZWN0VHlwZSxcbiAgVHhSZXN1bHQsXG4gIFdhbGxldEluZm8sXG4gIFdhbGxldFN0YXRlcyxcbiAgV2FsbGV0U3RhdHVzLFxufSBmcm9tICdAdGVycmEtZGV2L3VzZS13YWxsZXQnO1xuaW1wb3J0IHtcbiAgQ3JlYXRlVHhGYWlsZWQsXG4gIE5ldHdvcmtJbmZvLFxuICBTaWduUmVzdWx0LFxuICBUaW1lb3V0LFxuICBUeEZhaWxlZCxcbiAgVHhVbnNwZWNpZmllZEVycm9yLFxuICBVc2VyRGVuaWVkLFxufSBmcm9tICdAdGVycmEtZGV2L3dhbGxldC10eXBlcyc7XG5pbXBvcnQgeyBXZWJDb25uZWN0b3JDb250cm9sbGVyIH0gZnJvbSAnQHRlcnJhLWRldi93ZWItY29ubmVjdG9yLWNvbnRyb2xsZXInO1xuaW1wb3J0IHtcbiAgV2ViQ29ubmVjdG9yQ3JlYXRlVHhGYWlsZWQsXG4gIFdlYkNvbm5lY3RvclN0YXR1c1R5cGUsXG4gIFdlYkNvbm5lY3RvclR4RmFpbGVkLFxuICBXZWJDb25uZWN0b3JUeFJlc3VsdCxcbiAgV2ViQ29ubmVjdG9yVHhTdGF0dXMsXG4gIFdlYkNvbm5lY3RvclVzZXJEZW5pZWQsXG59IGZyb20gJ0B0ZXJyYS1kZXYvd2ViLWNvbm5lY3Rvci1pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQWNjQWRkcmVzcyxcbiAgQ3JlYXRlVHhPcHRpb25zLFxuICBQdWJsaWNLZXksXG4gIFN0ZFNpZ25Nc2csXG59IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5pbXBvcnQgZGVlcEVxdWFsIGZyb20gJ2Zhc3QtZGVlcC1lcXVhbCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBDSFJPTUVfRVhURU5TSU9OX0lOU1RBTExfVVJMLFxuICBERUZBVUxUX0NIUk9NRV9FWFRFTlNJT05fQ09NUEFUSUJMRV9CUk9XU0VSX0NIRUNLLFxuICBXRUJfRVhURU5TSU9OX0NPTk5FQ1RFRF9LRVksXG59IGZyb20gJy4vZW52JztcbmltcG9ydCB7XG4gIENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXIsXG4gIENocm9tZUV4dGVuc2lvbkNyZWF0ZVR4RmFpbGVkLFxuICBDaHJvbWVFeHRlbnNpb25TdGF0dXMsXG4gIENocm9tZUV4dGVuc2lvblR4RmFpbGVkLFxuICBDaHJvbWVFeHRlbnNpb25VbnNwZWNpZmllZEVycm9yLFxufSBmcm9tICcuL21vZHVsZXMvY2hyb21lLWV4dGVuc2lvbic7XG5pbXBvcnQge1xuICBjb25uZWN0IGFzIHJlQ29ubmVjdCxcbiAgY29ubmVjdElmU2Vzc2lvbkV4aXN0cyBhcyByZUNvbm5lY3RJZlNlc3Npb25FeGlzdHMsXG4gIFJlYWRvbmx5V2FsbGV0Q29udHJvbGxlcixcbiAgUmVhZG9ubHlXYWxsZXRTZXNzaW9uLFxufSBmcm9tICcuL21vZHVsZXMvcmVhZG9ubHktd2FsbGV0JztcbmltcG9ydCB7XG4gIGNvbm5lY3QgYXMgd2NDb25uZWN0LFxuICBjb25uZWN0SWZTZXNzaW9uRXhpc3RzIGFzIHdjQ29ubmVjdElmU2Vzc2lvbkV4aXN0cyxcbiAgV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIsXG4gIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyxcbiAgV2FsbGV0Q29ubmVjdENyZWF0ZVR4RmFpbGVkLFxuICBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cyxcbiAgV2FsbGV0Q29ubmVjdFRpbWVvdXQsXG4gIFdhbGxldENvbm5lY3RUeEZhaWxlZCxcbiAgV2FsbGV0Q29ubmVjdFR4UmVzdWx0LFxuICBXYWxsZXRDb25uZWN0VHhVbnNwZWNpZmllZEVycm9yLFxuICBXYWxsZXRDb25uZWN0VXNlckRlbmllZCxcbn0gZnJvbSAnLi9tb2R1bGVzL3dhbGxldGNvbm5lY3QnO1xuaW1wb3J0IHsgY2hlY2tBdmFpbGFibGVFeHRlbnNpb24gfSBmcm9tICcuL3V0aWxzL2NoZWNrQXZhaWxhYmxlRXh0ZW5zaW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBXYWxsZXRDb250cm9sbGVyT3B0aW9uc1xuICBleHRlbmRzIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiDimqDvuI8gRG9uJ3QgaGFyZGNvZGluZyB0aGlzLCB1c2UgZ2V0Q2hhaW4gT3B0aW9ucygpXG4gICAqXG4gICAqIGZhbGxiYWNrIG5ldHdvcmsgaWYgY29udHJvbGxlciBpcyBub3QgY29ubmVjdGVkXG4gICAqL1xuICBkZWZhdWx0TmV0d29yazogTmV0d29ya0luZm87XG5cbiAgLyoqXG4gICAqIOKaoO+4jyBEb24ndCBoYXJkY29kaW5nIHRoaXMsIHVzZSBnZXRDaGFpbiBPcHRpb25zKClcbiAgICpcbiAgICogZm9yIHdhbGxldGNvbm5lY3RcbiAgICpcbiAgICogVGhlIG5ldHdvcmsgcnVsZXMgcGFzc2VkIGJ5IHRoZSBUZXJyYSBTdGF0aW9uIE1vYmlsZSBhcmUgMCBpcyB0ZXN0bmV0LCAxIGlzIG1haW5uZXQuXG4gICAqXG4gICAqIEFsd2F5cyBzZXQgdGVzdG5ldCBmb3IgMCBhbmQgbWFpbm5ldCBmb3IgMS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgXG4gICAqIGNvbnN0IG1haW5uZXQ6IE5ldHdvcmtJbmZvID0ge1xuICAgKiAgbmFtZTogJ21haW5uZXQnLFxuICAgKiAgY2hhaW5JRDogJ2NvbHVtYnVzLTUnLFxuICAgKiAgbGNkOiAnaHR0cHM6Ly9sY2QudGVycmEuZGV2JyxcbiAgICogfVxuICAgKlxuICAgKiBjb25zdCB0ZXN0bmV0OiBOZXR3b3JrSW5mbyA9IHtcbiAgICogIG5hbWU6ICd0ZXN0bmV0JyxcbiAgICogIGNoYWluSUQ6ICdib21iYXktMTInLFxuICAgKiAgbGNkOiAnaHR0cHM6Ly9ib21iYXktbGNkLnRlcnJhLmRldicsXG4gICAqIH1cbiAgICpcbiAgICogY29uc3Qgd2FsbGV0Q29ubmVjdENoYWluSWRzOiBSZWNvcmQ8bnVtYmVyLCBOZXR3b3JrSW5mbz4gPSB7XG4gICAqICAgMDogdGVzdG5ldCxcbiAgICogICAxOiBtYWlubmV0LFxuICAgKiB9XG4gICAqXG4gICAqIDxXYWxsZXRQcm92aWRlciB3YWxsZXRDb25uZWN0Q2hhaW5JZHM9e3dhbGxldENvbm5lY3RDaGFpbklkc30+XG4gICAqIGBgYFxuICAgKi9cbiAgd2FsbGV0Q29ubmVjdENoYWluSWRzOiBSZWNvcmQ8bnVtYmVyLCBOZXR3b3JrSW5mbz47XG5cbiAgLyoqXG4gICAqIHJ1biBhdCBleGVjdXRpbmcgdGhlIGBjb25uZWN0KENvbm5lY3RUeXBlLlJFQURPTkxZKWBcbiAgICovXG4gIGNyZWF0ZVJlYWRvbmx5V2FsbGV0U2Vzc2lvbj86IChcbiAgICBuZXR3b3JrczogTmV0d29ya0luZm9bXSxcbiAgKSA9PiBQcm9taXNlPFJlYWRvbmx5V2FsbGV0U2Vzc2lvbiB8IG51bGw+O1xuXG4gIC8qKlxuICAgKiBtaWxsaXNlY29uZHMgdG8gd2FpdCBjaGVja2luZyBjaHJvbWUgZXh0ZW5zaW9uIGlzIGluc3RhbGxlZFxuICAgKlxuICAgKiBAZGVmYXVsdCAxMDAwICogMyBtaWxpc2Vjb25kc1xuICAgKi9cbiAgd2FpdGluZ0Nocm9tZUV4dGVuc2lvbkluc3RhbGxDaGVjaz86IG51bWJlcjtcblxuICAvKipcbiAgICog4pqg77iPIFRoaXMgQVBJIGlzIGFuIG9wdGlvbiBmb3Igd2FsbGV0IGRldmVsb3BlcnMuIFBsZWFzZSBkb24ndCB1c2UgZEFwcCBkZXZlbG9wZXJzLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBcbiAgICogPFdhbGxldFByb3ZpZGVyIGRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrPXsodXNlckFnZW50OiBzdHJpbmcpID0+IHtcbiAgICogICByZXR1cm4gL015V2FsbGV0XFwvLy50ZXN0KHVzZXJBZ2VudCk7XG4gICAqIH19PlxuICAgKiBgYGBcbiAgICovXG4gIGRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrPzogKFxuICAgIHVzZXJBZ2VudDogc3RyaW5nLFxuICApID0+IGJvb2xlYW47XG59XG5cbmNvbnN0IGRlZmF1bHRXYWl0aW5nQ2hyb21lRXh0ZW5zaW9uSW5zdGFsbENoZWNrID0gMTAwMCAqIDM7XG5cbmV4cG9ydCBjbGFzcyBXYWxsZXRDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSBjaHJvbWVFeHRlbnNpb246IENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSB3ZWJDb25uZWN0b3I6IFdlYkNvbm5lY3RvckNvbnRyb2xsZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSB3YWxsZXRDb25uZWN0OiBXYWxsZXRDb25uZWN0Q29udHJvbGxlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHJlYWRvbmx5V2FsbGV0OiBSZWFkb25seVdhbGxldENvbnRyb2xsZXIgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIF9hdmFpbGFibGVDb25uZWN0VHlwZXM6IEJlaGF2aW9yU3ViamVjdDxDb25uZWN0VHlwZVtdPjtcbiAgcHJpdmF0ZSBfYXZhaWxhYmxlSW5zdGFsbFR5cGVzOiBCZWhhdmlvclN1YmplY3Q8Q29ubmVjdFR5cGVbXT47XG4gIHByaXZhdGUgX3N0YXRlczogQmVoYXZpb3JTdWJqZWN0PFdhbGxldFN0YXRlcz47XG5cbiAgcHJpdmF0ZSBkaXNhYmxlUmVhZG9ubHlXYWxsZXQ6ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRpc2FibGVDaHJvbWVFeHRlbnNpb246ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRpc2FibGVXZWJFeHRlbnNpb246ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRpc2FibGVXYWxsZXRDb25uZWN0OiAoKCkgPT4gdm9pZCkgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIHJlYWRvbmx5IF9ub3RDb25uZWN0ZWQ6IFdhbGxldFN0YXRlcztcbiAgcHJpdmF0ZSByZWFkb25seSBfaW5pdGlhbGl6aW5nOiBXYWxsZXRTdGF0ZXM7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgb3B0aW9uczogV2FsbGV0Q29udHJvbGxlck9wdGlvbnMpIHtcbiAgICB0aGlzLl9ub3RDb25uZWN0ZWQgPSB7XG4gICAgICBzdGF0dXM6IFdhbGxldFN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCxcbiAgICAgIG5ldHdvcms6IG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgfTtcblxuICAgIHRoaXMuX2luaXRpYWxpemluZyA9IHtcbiAgICAgIHN0YXR1czogV2FsbGV0U3RhdHVzLklOSVRJQUxJWklORyxcbiAgICAgIG5ldHdvcms6IG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgfTtcblxuICAgIHRoaXMuX2F2YWlsYWJsZUNvbm5lY3RUeXBlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29ubmVjdFR5cGVbXT4oW1xuICAgICAgQ29ubmVjdFR5cGUuUkVBRE9OTFksXG4gICAgICBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNULFxuICAgIF0pO1xuXG4gICAgdGhpcy5fYXZhaWxhYmxlSW5zdGFsbFR5cGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb25uZWN0VHlwZVtdPihbXSk7XG5cbiAgICB0aGlzLl9zdGF0ZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFdhbGxldFN0YXRlcz4odGhpcy5faW5pdGlhbGl6aW5nKTtcblxuICAgIGxldCBudW1TZXNzaW9uQ2hlY2s6IG51bWJlciA9IDA7XG5cbiAgICAvLyB3YWl0IGNoZWNraW5nIHRoZSBhdmFpbGFiaWxpdHkgb2YgdGhlIGNocm9tZSBleHRlbnNpb25cbiAgICAvLyAwLiBjaGVjayBpZiBleHRlbnNpb24gd2FsbGV0IHNlc3Npb24gaXMgZXhpc3RzXG4gICAgY2hlY2tBdmFpbGFibGVFeHRlbnNpb24oXG4gICAgICBvcHRpb25zLndhaXRpbmdDaHJvbWVFeHRlbnNpb25JbnN0YWxsQ2hlY2sgPz9cbiAgICAgICAgZGVmYXVsdFdhaXRpbmdDaHJvbWVFeHRlbnNpb25JbnN0YWxsQ2hlY2ssXG4gICAgICB0aGlzLmlzQ2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXIoKSxcbiAgICApLnRoZW4oKGV4dGVuc2lvblR5cGUpID0+IHtcbiAgICAgIGlmIChleHRlbnNpb25UeXBlID09PSBDb25uZWN0VHlwZS5XRUJfQ09OTkVDVCkge1xuICAgICAgICB0aGlzLl9hdmFpbGFibGVDb25uZWN0VHlwZXMubmV4dChbXG4gICAgICAgICAgQ29ubmVjdFR5cGUuUkVBRE9OTFksXG4gICAgICAgICAgQ29ubmVjdFR5cGUuV0VCX0NPTk5FQ1QsXG4gICAgICAgICAgQ29ubmVjdFR5cGUuV0FMTEVUQ09OTkVDVCxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgdGhpcy53ZWJDb25uZWN0b3IgPSBuZXcgV2ViQ29ubmVjdG9yQ29udHJvbGxlcih3aW5kb3cpO1xuXG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMud2ViQ29ubmVjdG9yXG4gICAgICAgICAgLnN0YXR1cygpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKHdlYkV4dGVuc2lvblN0YXR1cykgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIHdlYkV4dGVuc2lvblN0YXR1cy50eXBlICE9PSBXZWJDb25uZWN0b3JTdGF0dXNUeXBlLklOSVRJQUxJWklOR1xuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKHdlYkV4dGVuc2lvblN0YXR1cykgPT4ge1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgd2ViRXh0ZW5zaW9uU3RhdHVzLnR5cGUgPT09IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuUkVBRFkgJiZcbiAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oV0VCX0VYVEVOU0lPTl9DT05ORUNURURfS0VZKSA9PT0gJ3RydWUnICYmXG4gICAgICAgICAgICAgICF0aGlzLmRpc2FibGVXYWxsZXRDb25uZWN0ICYmXG4gICAgICAgICAgICAgICF0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldFxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHRoaXMuZW5hYmxlV2ViRXh0ZW5zaW9uKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG51bVNlc3Npb25DaGVjayA9PT0gMCkge1xuICAgICAgICAgICAgICBudW1TZXNzaW9uQ2hlY2sgKz0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFdFQl9FWFRFTlNJT05fQ09OTkVDVEVEX0tFWSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGV4dGVuc2lvblR5cGUgPT09IENvbm5lY3RUeXBlLkNIUk9NRV9FWFRFTlNJT04pIHtcbiAgICAgICAgdGhpcy5fYXZhaWxhYmxlQ29ubmVjdFR5cGVzLm5leHQoW1xuICAgICAgICAgIENvbm5lY3RUeXBlLlJFQURPTkxZLFxuICAgICAgICAgIENvbm5lY3RUeXBlLkNIUk9NRV9FWFRFTlNJT04sXG4gICAgICAgICAgQ29ubmVjdFR5cGUuV0FMTEVUQ09OTkVDVCxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgdGhpcy5jaHJvbWVFeHRlbnNpb24gPSBuZXcgQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlcih7XG4gICAgICAgICAgZW5hYmxlV2FsbGV0Q29ubmVjdGlvbjogdHJ1ZSxcbiAgICAgICAgICBkZWZhdWx0TmV0d29yazogb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjazpcbiAgICAgICAgICAgIG9wdGlvbnMuZGFuZ2Vyb3VzbHlfX2Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyQ2hlY2sgPz9cbiAgICAgICAgICAgIERFRkFVTFRfQ0hST01FX0VYVEVOU0lPTl9DT01QQVRJQkxFX0JST1dTRVJfQ0hFQ0ssXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuY2hyb21lRXh0ZW5zaW9uXG4gICAgICAgICAgLnN0YXR1cygpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKGNocm9tZUV4dGVuc2lvblN0YXR1cykgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIGNocm9tZUV4dGVuc2lvblN0YXR1cyAhPT0gQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLklOSVRJQUxJWklOR1xuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKGNocm9tZUV4dGVuc2lvblN0YXR1cykgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB9IGNhdGNoIHt9XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgY2hyb21lRXh0ZW5zaW9uU3RhdHVzID09PVxuICAgICAgICAgICAgICAgIENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEICYmXG4gICAgICAgICAgICAgICF0aGlzLmRpc2FibGVXYWxsZXRDb25uZWN0ICYmXG4gICAgICAgICAgICAgICF0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldFxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHRoaXMuZW5hYmxlQ2hyb21lRXh0ZW5zaW9uKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG51bVNlc3Npb25DaGVjayA9PT0gMCkge1xuICAgICAgICAgICAgICBudW1TZXNzaW9uQ2hlY2sgKz0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaXNEZXNrdG9wQ2hyb21lKHRoaXMuaXNDaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlcigpKSkge1xuICAgICAgICAgIHRoaXMuX2F2YWlsYWJsZUluc3RhbGxUeXBlcy5uZXh0KFtDb25uZWN0VHlwZS5DSFJPTUVfRVhURU5TSU9OXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobnVtU2Vzc2lvbkNoZWNrID09PSAwKSB7XG4gICAgICAgICAgbnVtU2Vzc2lvbkNoZWNrICs9IDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZXModGhpcy5fbm90Q29ubmVjdGVkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gMS4gY2hlY2sgaWYgcmVhZG9ubHkgd2FsbGV0IHNlc3Npb24gaXMgZXhpc3RzXG4gICAgY29uc3QgZHJhZnRSZWFkb25seVdhbGxldCA9IHJlQ29ubmVjdElmU2Vzc2lvbkV4aXN0cygpO1xuXG4gICAgaWYgKGRyYWZ0UmVhZG9ubHlXYWxsZXQpIHtcbiAgICAgIHRoaXMuZW5hYmxlUmVhZG9ubHlXYWxsZXQoZHJhZnRSZWFkb25seVdhbGxldCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gMi4gY2hlY2sgaWYgd2FsbGV0Y29ubmVjdCBzZXNpc29uIGlzIGV4aXN0c1xuICAgIGNvbnN0IGRyYWZ0V2FsbGV0Q29ubmVjdCA9IHdjQ29ubmVjdElmU2Vzc2lvbkV4aXN0cyhvcHRpb25zKTtcblxuICAgIGlmIChcbiAgICAgIGRyYWZ0V2FsbGV0Q29ubmVjdCAmJlxuICAgICAgZHJhZnRXYWxsZXRDb25uZWN0LmdldExhdGVzdFNlc3Npb24oKS5zdGF0dXMgPT09XG4gICAgICAgIFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkNPTk5FQ1RFRFxuICAgICkge1xuICAgICAgdGhpcy5lbmFibGVXYWxsZXRDb25uZWN0KGRyYWZ0V2FsbGV0Q29ubmVjdCk7XG4gICAgfSBlbHNlIGlmIChudW1TZXNzaW9uQ2hlY2sgPT09IDApIHtcbiAgICAgIG51bVNlc3Npb25DaGVjayArPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh0aGlzLl9ub3RDb25uZWN0ZWQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAc2VlIFdhbGxldCNpc0Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyICovXG4gIGlzQ2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXIgPSAoKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMub3B0aW9ucy5kYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjayA/P1xuICAgICAgREVGQVVMVF9DSFJPTUVfRVhURU5TSU9OX0NPTVBBVElCTEVfQlJPV1NFUl9DSEVDS1xuICAgICkobmF2aWdhdG9yLnVzZXJBZ2VudCk7XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I2F2YWlsYWJsZUNvbm5lY3RUeXBlcyAqL1xuICBhdmFpbGFibGVDb25uZWN0VHlwZXMgPSAoKTogT2JzZXJ2YWJsZTxDb25uZWN0VHlwZVtdPiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX2F2YWlsYWJsZUNvbm5lY3RUeXBlcy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjYXZhaWxhYmxlSW5zdGFsbFR5cGVzICovXG4gIGF2YWlsYWJsZUluc3RhbGxUeXBlcyA9ICgpOiBPYnNlcnZhYmxlPENvbm5lY3RUeXBlW10+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlSW5zdGFsbFR5cGVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAc2VlIFdhbGxldCNzdGF0dXNcbiAgICogQHNlZSBXYWxsZXQjbmV0d29ya1xuICAgKiBAc2VlIFdhbGxldCN3YWxsZXRzXG4gICAqL1xuICBzdGF0ZXMgPSAoKTogT2JzZXJ2YWJsZTxXYWxsZXRTdGF0ZXM+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdGVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIC8qKiBAZGVwcmVjYXRlZCBwbGVhc2UgdXNlIGBzdGF0ZXMoKWAgKi9cbiAgc3RhdHVzID0gKCk6IE9ic2VydmFibGU8V2FsbGV0U3RhdHVzPiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlcy5waXBlKG1hcCgoZGF0YSkgPT4gZGF0YS5zdGF0dXMpKTtcbiAgfTtcblxuICAvKiogQGRlcHJlY2F0ZWQgcGxlYXNlIHVzZSBgc3RhdGVzKClgICovXG4gIG5ldHdvcmsgPSAoKTogT2JzZXJ2YWJsZTxOZXR3b3JrSW5mbz4gPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZXMucGlwZShtYXAoKGRhdGEpID0+IGRhdGEubmV0d29yaykpO1xuICB9O1xuXG4gIC8qKiBAZGVwcmVjYXRlZCBwbGVhc2UgdXNlIGBzdGF0ZXMoKWAgKi9cbiAgd2FsbGV0cyA9ICgpOiBPYnNlcnZhYmxlPFdhbGxldEluZm9bXT4gPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZXMucGlwZShcbiAgICAgIG1hcCgoZGF0YSkgPT5cbiAgICAgICAgZGF0YS5zdGF0dXMgPT09IFdhbGxldFN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEID8gZGF0YS53YWxsZXRzIDogW10sXG4gICAgICApLFxuICAgICk7XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I3JlY2hlY2tTdGF0dXMgKi9cbiAgcmVjaGVja1N0YXR1cyA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5kaXNhYmxlQ2hyb21lRXh0ZW5zaW9uKSB7XG4gICAgICB0aGlzLmNocm9tZUV4dGVuc2lvbj8ucmVjaGVja1N0YXR1cygpO1xuICAgIH1cbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjaW5zdGFsbCAqL1xuICBpbnN0YWxsID0gKHR5cGU6IENvbm5lY3RUeXBlKSA9PiB7XG4gICAgaWYgKHR5cGUgPT09IENvbm5lY3RUeXBlLkNIUk9NRV9FWFRFTlNJT04pIHtcbiAgICAgIHdpbmRvdy5vcGVuKENIUk9NRV9FWFRFTlNJT05fSU5TVEFMTF9VUkwsICdfYmxhbmsnKTtcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IENvbm5lY3RUeXBlLldFQl9DT05ORUNUKSB7XG4gICAgICBjb25zdCB3ZWJFeHRlbnNpb25TdGF0dXMgPSB0aGlzLndlYkNvbm5lY3Rvcj8uZ2V0TGFzdFN0YXR1cygpO1xuICAgICAgaWYgKFxuICAgICAgICB3ZWJFeHRlbnNpb25TdGF0dXM/LnR5cGUgPT09IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuTk9fQVZBSUxBQkxFICYmXG4gICAgICAgIHdlYkV4dGVuc2lvblN0YXR1cy5pbnN0YWxsTGlua1xuICAgICAgKSB7XG4gICAgICAgIHdpbmRvdy5vcGVuKHdlYkV4dGVuc2lvblN0YXR1cy5pbnN0YWxsTGluaywgJ19ibGFuaycpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oYENvbm5lY3RUeXBlIFwiJHt0eXBlfVwiIGRvZXMgbm90IHN1cHBvcnQgaW5zdGFsbCgpIGZ1bmN0aW9uYCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKiBAc2VlIFdhbGxldCNjb25uZWN0ICovXG4gIGNvbm5lY3QgPSAodHlwZTogQ29ubmVjdFR5cGUpID0+IHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgQ29ubmVjdFR5cGUuUkVBRE9OTFk6XG4gICAgICAgIGNvbnN0IG5ldHdvcmtzOiBOZXR3b3JrSW5mb1tdID0gT2JqZWN0LmtleXMoXG4gICAgICAgICAgdGhpcy5vcHRpb25zLndhbGxldENvbm5lY3RDaGFpbklkcyxcbiAgICAgICAgKS5tYXAoKGNoYWluSWQpID0+IHRoaXMub3B0aW9ucy53YWxsZXRDb25uZWN0Q2hhaW5JZHNbK2NoYWluSWRdKTtcblxuICAgICAgICBjb25zdCBjcmVhdGVSZWFkb25seVdhbGxldFNlc3Npb24gPVxuICAgICAgICAgIHRoaXMub3B0aW9ucy5jcmVhdGVSZWFkb25seVdhbGxldFNlc3Npb24/LihuZXR3b3JrcykgPz9cbiAgICAgICAgICByZWFkb25seVdhbGxldE1vZGFsKHsgbmV0d29ya3MgfSk7XG5cbiAgICAgICAgY3JlYXRlUmVhZG9ubHlXYWxsZXRTZXNzaW9uLnRoZW4oKHJlYWRvbmx5V2FsbGV0U2Vzc2lvbikgPT4ge1xuICAgICAgICAgIGlmIChyZWFkb25seVdhbGxldFNlc3Npb24pIHtcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlUmVhZG9ubHlXYWxsZXQocmVDb25uZWN0KHJlYWRvbmx5V2FsbGV0U2Vzc2lvbikpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNUOlxuICAgICAgICB0aGlzLmVuYWJsZVdhbGxldENvbm5lY3Qod2NDb25uZWN0KHRoaXMub3B0aW9ucykpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQ29ubmVjdFR5cGUuQ0hST01FX0VYVEVOU0lPTjpcbiAgICAgICAgdGhpcy5jaHJvbWVFeHRlbnNpb24hLmNvbm5lY3QoKS50aGVuKChzdWNjZXNzKSA9PiB7XG4gICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlQ2hyb21lRXh0ZW5zaW9uKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIENvbm5lY3RUeXBlLldFQl9DT05ORUNUOlxuICAgICAgICB0aGlzLmVuYWJsZVdlYkV4dGVuc2lvbigpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBDb25uZWN0VHlwZSFgKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I2Nvbm5lY3RSZWFkb25seSAqL1xuICBjb25uZWN0UmVhZG9ubHkgPSAodGVycmFBZGRyZXNzOiBzdHJpbmcsIG5ldHdvcms6IE5ldHdvcmtJbmZvKSA9PiB7XG4gICAgdGhpcy5lbmFibGVSZWFkb25seVdhbGxldChcbiAgICAgIHJlQ29ubmVjdCh7XG4gICAgICAgIHRlcnJhQWRkcmVzcyxcbiAgICAgICAgbmV0d29yayxcbiAgICAgIH0pLFxuICAgICk7XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I2Rpc2Nvbm5lY3QgKi9cbiAgZGlzY29ubmVjdCA9ICgpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlUmVhZG9ubHlXYWxsZXQgPSBudWxsO1xuXG4gICAgdGhpcy5kaXNhYmxlQ2hyb21lRXh0ZW5zaW9uPy4oKTtcbiAgICB0aGlzLmRpc2FibGVDaHJvbWVFeHRlbnNpb24gPSBudWxsO1xuXG4gICAgdGhpcy5kaXNhYmxlV2ViRXh0ZW5zaW9uPy4oKTtcbiAgICB0aGlzLmRpc2FibGVXZWJFeHRlbnNpb24gPSBudWxsO1xuXG4gICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdCA9IG51bGw7XG5cbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShXRUJfRVhURU5TSU9OX0NPTk5FQ1RFRF9LRVkpO1xuICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I3Bvc3QgKi9cbiAgcG9zdCA9IGFzeW5jIChcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICAgIC8vIFRPRE8gbm90IHdvcmsgYXQgdGhpcyB0aW1lLiBmb3IgdGhlIGZ1dHVyZSBleHRlbnNpb25cbiAgICB0eFRhcmdldDogeyB0ZXJyYUFkZHJlc3M/OiBzdHJpbmcgfSA9IHt9LFxuICApOiBQcm9taXNlPFR4UmVzdWx0PiA9PiB7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gY2hyb21lIGV4dGVuc2lvbiAtIGxlZ2FjeSBleHRlbnNpb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBpZiAodGhpcy5kaXNhYmxlQ2hyb21lRXh0ZW5zaW9uKSB7XG4gICAgICBpZiAoIXRoaXMuY2hyb21lRXh0ZW5zaW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgY2hyb21lRXh0ZW5zaW9uIGluc3RhbmNlIG5vdCBjcmVhdGVkIWApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICB0aGlzLmNocm9tZUV4dGVuc2lvblxuICAgICAgICAgIC8vIFRPRE8gbWFrZSBXYWxsZXRDb25uZWN0VHhSZXN1bHQgdG8gY29tbW9uIHR5cGVcbiAgICAgICAgICAucG9zdDxDcmVhdGVUeE9wdGlvbnMsIHsgcmVzdWx0OiBXYWxsZXRDb25uZWN0VHhSZXN1bHQgfT4odHgpXG4gICAgICAgICAgLnRoZW4oKHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAuLi50eCxcbiAgICAgICAgICAgICAgcmVzdWx0OiBwYXlsb2FkLnJlc3VsdCxcbiAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIH0gYXMgVHhSZXN1bHQ7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBDaHJvbWVFeHRlbnNpb25DcmVhdGVUeEZhaWxlZCkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgQ3JlYXRlVHhGYWlsZWQodHgsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIENocm9tZUV4dGVuc2lvblR4RmFpbGVkKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBUeEZhaWxlZCh0eCwgZXJyb3IudHhoYXNoLCBlcnJvci5tZXNzYWdlLCBudWxsKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBDaHJvbWVFeHRlbnNpb25VbnNwZWNpZmllZEVycm9yKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBUeFVuc3BlY2lmaWVkRXJyb3IodHgsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVXNlckRlbmllZEVycm9yXG4gICAgICAgICAgICAvLyBBbGwgdW5zcGVjaWZpZWQgZXJyb3JzLi4uXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gd2ViIGV4dGVuc2lvbiAtIG5ldyBleHRlbnNpb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBlbHNlIGlmICh0aGlzLmRpc2FibGVXZWJFeHRlbnNpb24pIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxUeFJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMud2ViQ29ubmVjdG9yKSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgd2ViRXh0ZW5zaW9uIGluc3RhbmNlIG5vdCBjcmVhdGVkIWApKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3ZWJFeHRlbnNpb25TdGF0ZXMgPSB0aGlzLndlYkNvbm5lY3Rvci5nZXRMYXN0U3RhdGVzKCk7XG5cbiAgICAgICAgaWYgKCF3ZWJFeHRlbnNpb25TdGF0ZXMpIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGB3ZWJFeHRlbnNpb24uZ2V0TGFzdFN0YXRlcygpIHJldHVybnMgdW5kZWZpbmVkIWApKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmb2N1c2VkV2FsbGV0ID0gdHhUYXJnZXQudGVycmFBZGRyZXNzXG4gICAgICAgICAgPyB3ZWJFeHRlbnNpb25TdGF0ZXMud2FsbGV0cy5maW5kKFxuICAgICAgICAgICAgICAoaXRlbVdhbGxldCkgPT4gaXRlbVdhbGxldC50ZXJyYUFkZHJlc3MgPT09IHR4VGFyZ2V0LnRlcnJhQWRkcmVzcyxcbiAgICAgICAgICAgICkgPz8gd2ViRXh0ZW5zaW9uU3RhdGVzLndhbGxldHNbMF1cbiAgICAgICAgICA6IHdlYkV4dGVuc2lvblN0YXRlcy5mb2N1c2VkV2FsbGV0QWRkcmVzc1xuICAgICAgICAgID8gd2ViRXh0ZW5zaW9uU3RhdGVzLndhbGxldHMuZmluZChcbiAgICAgICAgICAgICAgKGl0ZW1XYWxsZXQpID0+XG4gICAgICAgICAgICAgICAgaXRlbVdhbGxldC50ZXJyYUFkZHJlc3MgPT09XG4gICAgICAgICAgICAgICAgd2ViRXh0ZW5zaW9uU3RhdGVzLmZvY3VzZWRXYWxsZXRBZGRyZXNzLFxuICAgICAgICAgICAgKSA/PyB3ZWJFeHRlbnNpb25TdGF0ZXMud2FsbGV0c1swXVxuICAgICAgICAgIDogd2ViRXh0ZW5zaW9uU3RhdGVzLndhbGxldHNbMF07XG5cbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy53ZWJDb25uZWN0b3JcbiAgICAgICAgICAucG9zdChmb2N1c2VkV2FsbGV0LnRlcnJhQWRkcmVzcywgdHgpXG4gICAgICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgICAgICBuZXh0OiAoZXh0ZW5zaW9uVHhSZXN1bHQ6IFdlYkNvbm5lY3RvclR4UmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgIHN3aXRjaCAoZXh0ZW5zaW9uVHhSZXN1bHQuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBXZWJDb25uZWN0b3JUeFN0YXR1cy5TVUNDRUVEOlxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIC4uLnR4LFxuICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IGV4dGVuc2lvblR4UmVzdWx0LnBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFdlYkNvbm5lY3RvclVzZXJEZW5pZWQpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IFVzZXJEZW5pZWQoKSk7XG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBXZWJDb25uZWN0b3JDcmVhdGVUeEZhaWxlZCkge1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgQ3JlYXRlVHhGYWlsZWQodHgsIGVycm9yLm1lc3NhZ2UpKTtcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIFdlYkNvbm5lY3RvclR4RmFpbGVkKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KFxuICAgICAgICAgICAgICAgICAgbmV3IFR4RmFpbGVkKFxuICAgICAgICAgICAgICAgICAgICB0eCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3IudHhoYXNoLFxuICAgICAgICAgICAgICAgICAgICBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvci5yYXdfbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWplY3QoXG4gICAgICAgICAgICAgICAgICBuZXcgVHhVbnNwZWNpZmllZEVycm9yKFxuICAgICAgICAgICAgICAgICAgICB0eCxcbiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnIGluIGVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIHdhbGxldCBjb25uZWN0XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgZWxzZSBpZiAodGhpcy53YWxsZXRDb25uZWN0KSB7XG4gICAgICByZXR1cm4gdGhpcy53YWxsZXRDb25uZWN0XG4gICAgICAgIC5wb3N0KHR4KVxuICAgICAgICAudGhlbihcbiAgICAgICAgICAocmVzdWx0KSA9PlxuICAgICAgICAgICAgKHtcbiAgICAgICAgICAgICAgLi4udHgsXG4gICAgICAgICAgICAgIHJlc3VsdCxcbiAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIH0gYXMgVHhSZXN1bHQpLFxuICAgICAgICApXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICBsZXQgdGhyb3dFcnJvciA9IGVycm9yO1xuXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFdhbGxldENvbm5lY3RVc2VyRGVuaWVkKSB7XG4gICAgICAgICAgICAgIHRocm93RXJyb3IgPSBuZXcgVXNlckRlbmllZCgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIFdhbGxldENvbm5lY3RDcmVhdGVUeEZhaWxlZCkge1xuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IENyZWF0ZVR4RmFpbGVkKHR4LCBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBXYWxsZXRDb25uZWN0VHhGYWlsZWQpIHtcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBUeEZhaWxlZChcbiAgICAgICAgICAgICAgICB0eCxcbiAgICAgICAgICAgICAgICBlcnJvci50eGhhc2gsXG4gICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICBlcnJvci5yYXdfbWVzc2FnZSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBXYWxsZXRDb25uZWN0VGltZW91dCkge1xuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFRpbWVvdXQoZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgV2FsbGV0Q29ubmVjdFR4VW5zcGVjaWZpZWRFcnJvcikge1xuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFR4VW5zcGVjaWZpZWRFcnJvcih0eCwgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFR4VW5zcGVjaWZpZWRFcnJvcihcbiAgICAgICAgICAgICAgdHgsXG4gICAgICAgICAgICAgICdtZXNzYWdlJyBpbiBlcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aHJvdyB0aHJvd0Vycm9yO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBhcmUgbm8gY29ubmVjdGlvbnMgdGhhdCBjYW4gYmUgcG9zdGluZyB0eCFgKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I3NpZ24gKi9cbiAgc2lnbiA9IGFzeW5jIChcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICAgIC8vIFRPRE8gbm90IHdvcmsgYXQgdGhpcyB0aW1lLiBmb3IgdGhlIGZ1dHVyZSBleHRlbnNpb25cbiAgICB0eFRhcmdldDogeyB0ZXJyYUFkZHJlc3M/OiBzdHJpbmcgfSA9IHt9LFxuICApOiBQcm9taXNlPFNpZ25SZXN1bHQ+ID0+IHtcbiAgICBpbnRlcmZhY2UgU2lnblJlc3VsdFJhdyBleHRlbmRzIENyZWF0ZVR4T3B0aW9ucyB7XG4gICAgICByZXN1bHQ6IHtcbiAgICAgICAgcHVibGljX2tleTogc3RyaW5nIHwgUHVibGljS2V5LkRhdGE7XG4gICAgICAgIHJlY2lkOiBudW1iZXI7XG4gICAgICAgIHNpZ25hdHVyZTogc3RyaW5nO1xuICAgICAgICBzdGRTaWduTXNnRGF0YTogU3RkU2lnbk1zZy5EYXRhO1xuICAgICAgfTtcbiAgICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZGlzYWJsZUNocm9tZUV4dGVuc2lvbikge1xuICAgICAgaWYgKCF0aGlzLmNocm9tZUV4dGVuc2lvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNocm9tZUV4dGVuc2lvbiBpbnN0YW5jZSBub3QgY3JlYXRlZCFgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuY2hyb21lRXh0ZW5zaW9uXG4gICAgICAgIC5zaWduPENyZWF0ZVR4T3B0aW9ucywgU2lnblJlc3VsdFJhdz4odHgpXG4gICAgICAgIC50aGVuKCh7IHBheWxvYWQgfSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHB1YmxpY0tleTogUHVibGljS2V5LkRhdGEgPVxuICAgICAgICAgICAgdHlwZW9mIHBheWxvYWQucmVzdWx0LnB1YmxpY19rZXkgPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgdHlwZTogJ3RlbmRlcm1pbnQvUHViS2V5U2VjcDI1NmsxJyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwYXlsb2FkLnJlc3VsdC5wdWJsaWNfa2V5LFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiBwYXlsb2FkLnJlc3VsdC5wdWJsaWNfa2V5O1xuXG4gICAgICAgICAgY29uc3Qgc2lnblJlc3VsdDogU2lnblJlc3VsdFsncmVzdWx0J10gPSB7XG4gICAgICAgICAgICAuLi5wYXlsb2FkLnJlc3VsdCxcbiAgICAgICAgICAgIHB1YmxpY19rZXk6IHB1YmxpY0tleSxcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLnR4LFxuICAgICAgICAgICAgcmVzdWx0OiBzaWduUmVzdWx0LFxuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgQ2hyb21lRXh0ZW5zaW9uQ3JlYXRlVHhGYWlsZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBDcmVhdGVUeEZhaWxlZCh0eCwgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIENocm9tZUV4dGVuc2lvblR4RmFpbGVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHhGYWlsZWQodHgsIGVycm9yLnR4aGFzaCwgZXJyb3IubWVzc2FnZSwgbnVsbCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIENocm9tZUV4dGVuc2lvblVuc3BlY2lmaWVkRXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeFVuc3BlY2lmaWVkRXJyb3IodHgsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBVc2VyRGVuaWVkIC0gY2hyb21lIGV4dGVuc2lvbiB3aWxsIHNlbnQgb3JpZ2luYWwgVXNlckRlbmllZCBlcnJvciB0eXBlXG4gICAgICAgICAgLy8gQWxsIHVuc3BlY2lmaWVkIGVycm9ycy4uLlxuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHNpZ24oKSBtZXRob2Qgb25seSBhdmFpbGFibGUgb24gY2hyb21lIGV4dGVuc2lvbmApO1xuICAgIC8vIFRPRE8gaW1wbGVtZW50cyBzaWduKCkgdG8gb3RoZXIgY29ubmVjdCB0eXBlc1xuICB9O1xuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gaW50ZXJuYWxcbiAgLy8gY29ubmVjdCB0eXBlIGNoYW5naW5nXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZXMgPSAobmV4dDogV2FsbGV0U3RhdGVzKSA9PiB7XG4gICAgY29uc3QgcHJldiA9IHRoaXMuX3N0YXRlcy5nZXRWYWx1ZSgpO1xuXG4gICAgaWYgKFxuICAgICAgbmV4dC5zdGF0dXMgPT09IFdhbGxldFN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEICYmXG4gICAgICBuZXh0LndhbGxldHMubGVuZ3RoID09PSAwXG4gICAgKSB7XG4gICAgICBjb25zb2xlLnRyYWNlKCc/Pz8nKTtcbiAgICB9XG5cbiAgICBpZiAocHJldi5zdGF0dXMgIT09IG5leHQuc3RhdHVzIHx8ICFkZWVwRXF1YWwocHJldiwgbmV4dCkpIHtcbiAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KG5leHQpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGVuYWJsZVJlYWRvbmx5V2FsbGV0ID0gKHJlYWRvbmx5V2FsbGV0OiBSZWFkb25seVdhbGxldENvbnRyb2xsZXIpID0+IHtcbiAgICB0aGlzLmRpc2FibGVXYWxsZXRDb25uZWN0Py4oKTtcbiAgICB0aGlzLmRpc2FibGVDaHJvbWVFeHRlbnNpb24/LigpO1xuICAgIHRoaXMuZGlzYWJsZVdlYkV4dGVuc2lvbj8uKCk7XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLnJlYWRvbmx5V2FsbGV0ID09PSByZWFkb25seVdhbGxldCB8fFxuICAgICAgKHRoaXMucmVhZG9ubHlXYWxsZXQ/LnRlcnJhQWRkcmVzcyA9PT0gcmVhZG9ubHlXYWxsZXQudGVycmFBZGRyZXNzICYmXG4gICAgICAgIHRoaXMucmVhZG9ubHlXYWxsZXQubmV0d29yayA9PT0gcmVhZG9ubHlXYWxsZXQubmV0d29yaylcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFkb25seVdhbGxldCkge1xuICAgICAgdGhpcy5yZWFkb25seVdhbGxldC5kaXNjb25uZWN0KCk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWFkb25seVdhbGxldCA9IHJlYWRvbmx5V2FsbGV0O1xuXG4gICAgdGhpcy51cGRhdGVTdGF0ZXMoe1xuICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgIG5ldHdvcms6IHJlYWRvbmx5V2FsbGV0Lm5ldHdvcmssXG4gICAgICB3YWxsZXRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBjb25uZWN0VHlwZTogQ29ubmVjdFR5cGUuUkVBRE9OTFksXG4gICAgICAgICAgdGVycmFBZGRyZXNzOiByZWFkb25seVdhbGxldC50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgZGVzaWduOiAncmVhZG9ubHknLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIHRoaXMuZGlzYWJsZVJlYWRvbmx5V2FsbGV0ID0gKCkgPT4ge1xuICAgICAgcmVhZG9ubHlXYWxsZXQuZGlzY29ubmVjdCgpO1xuICAgICAgdGhpcy5yZWFkb25seVdhbGxldCA9IG51bGw7XG4gICAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldCA9IG51bGw7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIGVuYWJsZVdlYkV4dGVuc2lvbiA9ICgpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlQ2hyb21lRXh0ZW5zaW9uPy4oKTtcblxuICAgIGlmICh0aGlzLmRpc2FibGVXZWJFeHRlbnNpb24gfHwgIXRoaXMud2ViQ29ubmVjdG9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZXh0ZW5zaW9uU3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLndlYkNvbm5lY3Rvci5zdGF0dXMoKSxcbiAgICAgIHRoaXMud2ViQ29ubmVjdG9yLnN0YXRlcygpLFxuICAgIF0pLnN1YnNjcmliZSgoW3N0YXR1cywgc3RhdGVzXSkgPT4ge1xuICAgICAgaWYgKCFzdGF0ZXMpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3RhdHVzLnR5cGUgPT09IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuUkVBRFkpIHtcbiAgICAgICAgaWYgKHN0YXRlcy53YWxsZXRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBmb2N1c2VkV2FsbGV0ID0gc3RhdGVzLmZvY3VzZWRXYWxsZXRBZGRyZXNzXG4gICAgICAgICAgICA/IHN0YXRlcy53YWxsZXRzLmZpbmQoXG4gICAgICAgICAgICAgICAgKGl0ZW1XYWxsZXQpID0+XG4gICAgICAgICAgICAgICAgICBpdGVtV2FsbGV0LnRlcnJhQWRkcmVzcyA9PT0gc3RhdGVzLmZvY3VzZWRXYWxsZXRBZGRyZXNzLFxuICAgICAgICAgICAgICApID8/IHN0YXRlcy53YWxsZXRzWzBdXG4gICAgICAgICAgICA6IHN0YXRlcy53YWxsZXRzWzBdO1xuXG4gICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZXMoe1xuICAgICAgICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgICAgICAgIG5ldHdvcms6IHN0YXRlcy5uZXR3b3JrLFxuICAgICAgICAgICAgd2FsbGV0czogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29ubmVjdFR5cGU6IENvbm5lY3RUeXBlLldFQl9DT05ORUNULFxuICAgICAgICAgICAgICAgIHRlcnJhQWRkcmVzczogZm9jdXNlZFdhbGxldC50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgZGVzaWduOiBmb2N1c2VkV2FsbGV0LmRlc2lnbixcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoc3RhdHVzLnR5cGUgPT09IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuTk9fQVZBSUxBQkxFKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFdFQl9FWFRFTlNJT05fQ09OTkVDVEVEX0tFWSk7XG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG5cbiAgICAgICAgaWYgKCFzdGF0dXMuaXNBcHByb3ZlZCAmJiB0aGlzLmRpc2FibGVXZWJFeHRlbnNpb24pIHtcbiAgICAgICAgICB0aGlzLmRpc2FibGVXZWJFeHRlbnNpb24oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oV0VCX0VYVEVOU0lPTl9DT05ORUNURURfS0VZLCAndHJ1ZScpO1xuXG4gICAgY29uc3QgbGFzdEV4dGVuc2lvblN0YXR1cyA9IHRoaXMud2ViQ29ubmVjdG9yLmdldExhc3RTdGF0dXMoKTtcblxuICAgIGlmIChcbiAgICAgIGxhc3RFeHRlbnNpb25TdGF0dXMudHlwZSA9PT0gV2ViQ29ubmVjdG9yU3RhdHVzVHlwZS5OT19BVkFJTEFCTEUgJiZcbiAgICAgIGxhc3RFeHRlbnNpb25TdGF0dXMuaXNBcHByb3ZlZCA9PT0gZmFsc2VcbiAgICApIHtcbiAgICAgIHRoaXMud2ViQ29ubmVjdG9yLnJlcXVlc3RBcHByb3ZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMuZGlzYWJsZVdlYkV4dGVuc2lvbiA9ICgpID0+IHtcbiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFdFQl9FWFRFTlNJT05fQ09OTkVDVEVEX0tFWSk7XG4gICAgICBleHRlbnNpb25TdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMuZGlzYWJsZVdlYkV4dGVuc2lvbiA9IG51bGw7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIGVuYWJsZUNocm9tZUV4dGVuc2lvbiA9ICgpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2ViRXh0ZW5zaW9uPy4oKTtcblxuICAgIGlmICh0aGlzLmRpc2FibGVDaHJvbWVFeHRlbnNpb24gfHwgIXRoaXMuY2hyb21lRXh0ZW5zaW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZXh0ZW5zaW9uU3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmNocm9tZUV4dGVuc2lvbi5zdGF0dXMoKSxcbiAgICAgIHRoaXMuY2hyb21lRXh0ZW5zaW9uLm5ldHdvcmtJbmZvKCksXG4gICAgICB0aGlzLmNocm9tZUV4dGVuc2lvbi50ZXJyYUFkZHJlc3MoKSxcbiAgICBdKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKFtzdGF0dXMsIG5ldHdvcmtJbmZvLCB0ZXJyYUFkZHJlc3NdKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBzdGF0dXMgPT09IENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEICYmXG4gICAgICAgICAgdHlwZW9mIHRlcnJhQWRkcmVzcyA9PT0gJ3N0cmluZycgJiZcbiAgICAgICAgICBBY2NBZGRyZXNzLnZhbGlkYXRlKHRlcnJhQWRkcmVzcylcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZXMoe1xuICAgICAgICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgICAgICAgIG5ldHdvcms6IG5ldHdvcmtJbmZvLFxuICAgICAgICAgICAgd2FsbGV0czogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29ubmVjdFR5cGU6IENvbm5lY3RUeXBlLkNIUk9NRV9FWFRFTlNJT04sXG4gICAgICAgICAgICAgICAgdGVycmFBZGRyZXNzLFxuICAgICAgICAgICAgICAgIGRlc2lnbjogJ2V4dGVuc2lvbicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmRpc2FibGVDaHJvbWVFeHRlbnNpb24gPSAoKSA9PiB7XG4gICAgICB0aGlzLmNocm9tZUV4dGVuc2lvbj8uZGlzY29ubmVjdCgpO1xuICAgICAgZXh0ZW5zaW9uU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB0aGlzLmRpc2FibGVDaHJvbWVFeHRlbnNpb24gPSBudWxsO1xuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBlbmFibGVXYWxsZXRDb25uZWN0ID0gKHdhbGxldENvbm5lY3Q6IFdhbGxldENvbm5lY3RDb250cm9sbGVyKSA9PiB7XG4gICAgdGhpcy5kaXNhYmxlUmVhZG9ubHlXYWxsZXQ/LigpO1xuICAgIHRoaXMuZGlzYWJsZUNocm9tZUV4dGVuc2lvbj8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2ViRXh0ZW5zaW9uPy4oKTtcblxuICAgIGlmICh0aGlzLndhbGxldENvbm5lY3QgPT09IHdhbGxldENvbm5lY3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy53YWxsZXRDb25uZWN0KSB7XG4gICAgICB0aGlzLndhbGxldENvbm5lY3QuZGlzY29ubmVjdCgpO1xuICAgIH1cblxuICAgIHRoaXMud2FsbGV0Q29ubmVjdCA9IHdhbGxldENvbm5lY3Q7XG5cbiAgICBjb25zdCBzdWJzY3JpYmVXYWxsZXRDb25uZWN0ID0gKFxuICAgICAgd2M6IFdhbGxldENvbm5lY3RDb250cm9sbGVyLFxuICAgICk6IFN1YnNjcmlwdGlvbiA9PiB7XG4gICAgICByZXR1cm4gd2Muc2Vzc2lvbigpLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChzdGF0dXMpID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKHN0YXR1cy5zdGF0dXMpIHtcbiAgICAgICAgICAgIGNhc2UgV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMuQ09OTkVDVEVEOlxuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgICAgICAgICAgICBuZXR3b3JrOlxuICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLndhbGxldENvbm5lY3RDaGFpbklkc1tzdGF0dXMuY2hhaW5JZF0gPz9cbiAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgICAgICAgICB3YWxsZXRzOiBbXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RUeXBlOiBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNULFxuICAgICAgICAgICAgICAgICAgICB0ZXJyYUFkZHJlc3M6IHN0YXR1cy50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgIGRlc2lnbjogJ3dhbGxldGNvbm5lY3QnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh0aGlzLl9ub3RDb25uZWN0ZWQpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgY29uc3Qgd2FsbGV0Q29ubmVjdFNlc3Npb25TdWJzY3JpcHRpb24gPVxuICAgICAgc3Vic2NyaWJlV2FsbGV0Q29ubmVjdCh3YWxsZXRDb25uZWN0KTtcblxuICAgIHRoaXMuZGlzYWJsZVdhbGxldENvbm5lY3QgPSAoKSA9PiB7XG4gICAgICB0aGlzLndhbGxldENvbm5lY3Q/LmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMud2FsbGV0Q29ubmVjdCA9IG51bGw7XG4gICAgICB3YWxsZXRDb25uZWN0U2Vzc2lvblN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdCA9IG51bGw7XG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==