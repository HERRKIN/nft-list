"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChromeExtensionController = void 0;
const browser_check_1 = require("@terra-dev/browser-check");
const terra_js_1 = require("@terra-money/terra.js");
const rxjs_1 = require("rxjs");
const extensionFixer_1 = require("./extensionFixer");
const storage_1 = require("./storage");
const types_1 = require("./types");
class ChromeExtensionController {
    constructor(options) {
        this.options = options;
        this.doneFirstCheck = false;
        this.status = () => {
            return this._status.asObservable();
        };
        this.networkInfo = () => {
            return this._networkInfo.asObservable();
        };
        this.terraAddress = () => {
            return this._terraAddress.asObservable();
        };
        this.checkStatus = async (waitingExtensionScriptInjection = false) => {
            // do not check if browser isn't a chrome
            if (!this.isDesktopChrome) {
                return;
            }
            // ignore the checks before first check done
            // first check -------------------------------â†’ done
            // --------------- second check (ignore)
            if (!waitingExtensionScriptInjection && !this.doneFirstCheck) {
                return;
            }
            // check the extension installed
            const isExtensionInstalled = waitingExtensionScriptInjection
                ? await intervalCheck(20, () => this._extension.isAvailable())
                : this._extension.isAvailable();
            this.doneFirstCheck = true;
            if (!isExtensionInstalled) {
                this._status.next(types_1.ChromeExtensionStatus.UNAVAILABLE);
                return;
            }
            // get networkInfo from extension
            const infoPayload = await this._extension.info();
            if (infoPayload &&
                this._networkInfo.getValue().chainID !== infoPayload.chainID) {
                this._networkInfo.next(infoPayload);
            }
            if (this.options.enableWalletConnection) {
                const storageStoredWalletAddress = storage_1.getStoredAddress();
                // if the storage has wallet address
                if (storageStoredWalletAddress &&
                    terra_js_1.AccAddress.validate(storageStoredWalletAddress)) {
                    this._status.next(types_1.ChromeExtensionStatus.WALLET_CONNECTED);
                    // TODO timer check?
                    const connectResult = await this._extension.connect();
                    // if address of extension is not same with the address of localStorage
                    if (connectResult.address &&
                        terra_js_1.AccAddress.validate(connectResult.address)) {
                        storage_1.storeAddress(connectResult.address);
                    }
                    if (!!connectResult.address) {
                        if (this._terraAddress.getValue() !== connectResult.address) {
                            this._terraAddress.next(connectResult.address);
                        }
                    }
                    else {
                        storage_1.clearStore();
                        this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    }
                }
                else {
                    if (storageStoredWalletAddress) {
                        storage_1.clearStore();
                    }
                    this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    this._terraAddress.next(null);
                }
            }
            else {
                this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                this._terraAddress.next(null);
            }
        };
        this.connect = async () => {
            var _a;
            const result = await this._extension.connect();
            if (result === null || result === void 0 ? void 0 : result.address) {
                const walletAddress = result.address;
                storage_1.storeAddress(walletAddress);
                await this.checkStatus();
            }
            return (_a = result === null || result === void 0 ? void 0 : result.address) !== null && _a !== void 0 ? _a : false;
        };
        this.disconnect = () => {
            storage_1.clearStore();
            this.checkStatus();
        };
        this.recheckStatus = () => {
            if (!this._extension.inTransactionProgress()) {
                this.checkStatus(false);
            }
        };
        this.post = (data) => {
            return this._extension.post(data);
        };
        this.sign = (data) => {
            return this._extension.sign(data);
        };
        this.isDesktopChrome =
            typeof window !== 'undefined' &&
                browser_check_1.isDesktopChrome(options.dangerously__chromeExtensionCompatibleBrowserCheck(navigator.userAgent));
        this._status = new rxjs_1.BehaviorSubject(this.isDesktopChrome
            ? types_1.ChromeExtensionStatus.INITIALIZING
            : types_1.ChromeExtensionStatus.UNAVAILABLE);
        this._networkInfo = new rxjs_1.BehaviorSubject(options.defaultNetwork);
        this._terraAddress = new rxjs_1.BehaviorSubject(storage_1.getStoredAddress());
        this._extension = extensionFixer_1.extensionFixer(new terra_js_1.Extension());
        if (this.isDesktopChrome) {
            this.checkStatus(true);
        }
    }
}
exports.ChromeExtensionController = ChromeExtensionController;
async function intervalCheck(count, fn, intervalMs = 500) {
    let i = -1;
    while (++i < count) {
        if (fn()) {
            return true;
        }
        await new Promise((resolve) => setTimeout(resolve, intervalMs));
    }
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9AdGVycmEtZGV2L2Nocm9tZS1leHRlbnNpb24vQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0REFBMkQ7QUFFM0Qsb0RBQThEO0FBQzlELCtCQUF1QztBQUN2QyxxREFBa0U7QUFDbEUsdUNBQXVFO0FBQ3ZFLG1DQUFnRDtBQVVoRCxNQUFhLHlCQUF5QjtJQVNwQyxZQUFxQixPQUF5QztRQUF6QyxZQUFPLEdBQVAsT0FBTyxDQUFrQztRQUh0RCxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQStCL0IsV0FBTSxHQUFHLEdBQUcsRUFBRTtZQUNaLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNyQyxDQUFDLENBQUM7UUFFRixnQkFBVyxHQUFHLEdBQUcsRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUMsQ0FBQyxDQUFDO1FBRUYsaUJBQVksR0FBRyxHQUFHLEVBQUU7WUFDbEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNDLENBQUMsQ0FBQztRQUVGLGdCQUFXLEdBQUcsS0FBSyxFQUFFLGtDQUEyQyxLQUFLLEVBQUUsRUFBRTtZQUN2RSx5Q0FBeUM7WUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3pCLE9BQU87YUFDUjtZQUVELDRDQUE0QztZQUM1QyxvREFBb0Q7WUFDcEQsd0NBQXdDO1lBQ3hDLElBQUksQ0FBQywrQkFBK0IsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQzVELE9BQU87YUFDUjtZQUVELGdDQUFnQztZQUNoQyxNQUFNLG9CQUFvQixHQUFHLCtCQUErQjtnQkFDMUQsQ0FBQyxDQUFDLE1BQU0sYUFB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QWUsQ0FBZ0IsMEJBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLElBQUksQ0FBQyxVQUFVLEdBQUcsK0JBQWMsQ0FBQyxJQUFJLG9CQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRWxELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztDQStIRjtBQWxLRCw4REFrS0M7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUMxQixLQUFhLEVBQ2IsRUFBaUIsRUFDakIsYUFBcUIsR0FBRztJQUV4QixJQUFJLENBQUMsR0FBVyxDQUFDLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsQ0FBQyxHQUFHLEtBQUssRUFBRTtRQUNsQixJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQ1IsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztLQUNqRTtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRGVza3RvcENocm9tZSB9IGZyb20gJ0B0ZXJyYS1kZXYvYnJvd3Nlci1jaGVjayc7XG5pbXBvcnQgeyBOZXR3b3JrSW5mbyB9IGZyb20gJ0B0ZXJyYS1kZXYvd2FsbGV0LXR5cGVzJztcbmltcG9ydCB7IEFjY0FkZHJlc3MsIEV4dGVuc2lvbiB9IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGV4dGVuc2lvbkZpeGVyLCBGaXhlZEV4dGVuc2lvbiB9IGZyb20gJy4vZXh0ZW5zaW9uRml4ZXInO1xuaW1wb3J0IHsgY2xlYXJTdG9yZSwgZ2V0U3RvcmVkQWRkcmVzcywgc3RvcmVBZGRyZXNzIH0gZnJvbSAnLi9zdG9yYWdlJztcbmltcG9ydCB7IENocm9tZUV4dGVuc2lvblN0YXR1cyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXJPcHRpb25zIHtcbiAgZGVmYXVsdE5ldHdvcms6IE5ldHdvcmtJbmZvO1xuICBlbmFibGVXYWxsZXRDb25uZWN0aW9uOiBib29sZWFuO1xuICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjazogKFxuICAgIHVzZXJBZ2VudDogc3RyaW5nLFxuICApID0+IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBDaHJvbWVFeHRlbnNpb25Db250cm9sbGVyIHtcbiAgcmVhZG9ubHkgX3N0YXR1czogQmVoYXZpb3JTdWJqZWN0PENocm9tZUV4dGVuc2lvblN0YXR1cz47XG4gIHJlYWRvbmx5IF9uZXR3b3JrSW5mbzogQmVoYXZpb3JTdWJqZWN0PE5ldHdvcmtJbmZvPjtcbiAgcmVhZG9ubHkgX3RlcnJhQWRkcmVzczogQmVoYXZpb3JTdWJqZWN0PHN0cmluZyB8IG51bGw+O1xuICByZWFkb25seSBfZXh0ZW5zaW9uOiBGaXhlZEV4dGVuc2lvbjtcblxuICBwcml2YXRlIGRvbmVGaXJzdENoZWNrID0gZmFsc2U7XG4gIHByaXZhdGUgcmVhZG9ubHkgaXNEZXNrdG9wQ2hyb21lOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IG9wdGlvbnM6IENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXJPcHRpb25zKSB7XG4gICAgdGhpcy5pc0Rlc2t0b3BDaHJvbWUgPVxuICAgICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgIGlzRGVza3RvcENocm9tZShcbiAgICAgICAgb3B0aW9ucy5kYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjayhcbiAgICAgICAgICBuYXZpZ2F0b3IudXNlckFnZW50LFxuICAgICAgICApLFxuICAgICAgKTtcblxuICAgIHRoaXMuX3N0YXR1cyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q2hyb21lRXh0ZW5zaW9uU3RhdHVzPihcbiAgICAgIHRoaXMuaXNEZXNrdG9wQ2hyb21lXG4gICAgICAgID8gQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLklOSVRJQUxJWklOR1xuICAgICAgICA6IENocm9tZUV4dGVuc2lvblN0YXR1cy5VTkFWQUlMQUJMRSxcbiAgICApO1xuXG4gICAgdGhpcy5fbmV0d29ya0luZm8gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5ldHdvcmtJbmZvPihcbiAgICAgIG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgKTtcblxuICAgIHRoaXMuX3RlcnJhQWRkcmVzcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4oZ2V0U3RvcmVkQWRkcmVzcygpKTtcblxuICAgIHRoaXMuX2V4dGVuc2lvbiA9IGV4dGVuc2lvbkZpeGVyKG5ldyBFeHRlbnNpb24oKSk7XG5cbiAgICBpZiAodGhpcy5pc0Rlc2t0b3BDaHJvbWUpIHtcbiAgICAgIHRoaXMuY2hlY2tTdGF0dXModHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgc3RhdHVzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0dXMuYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgbmV0d29ya0luZm8gPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX25ldHdvcmtJbmZvLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIHRlcnJhQWRkcmVzcyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fdGVycmFBZGRyZXNzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIGNoZWNrU3RhdHVzID0gYXN5bmMgKHdhaXRpbmdFeHRlbnNpb25TY3JpcHRJbmplY3Rpb246IGJvb2xlYW4gPSBmYWxzZSkgPT4ge1xuICAgIC8vIGRvIG5vdCBjaGVjayBpZiBicm93c2VyIGlzbid0IGEgY2hyb21lXG4gICAgaWYgKCF0aGlzLmlzRGVza3RvcENocm9tZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGlnbm9yZSB0aGUgY2hlY2tzIGJlZm9yZSBmaXJzdCBjaGVjayBkb25lXG4gICAgLy8gZmlyc3QgY2hlY2sgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLeKGkiBkb25lXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tIHNlY29uZCBjaGVjayAoaWdub3JlKVxuICAgIGlmICghd2FpdGluZ0V4dGVuc2lvblNjcmlwdEluamVjdGlvbiAmJiAhdGhpcy5kb25lRmlyc3RDaGVjaykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGNoZWNrIHRoZSBleHRlbnNpb24gaW5zdGFsbGVkXG4gICAgY29uc3QgaXNFeHRlbnNpb25JbnN0YWxsZWQgPSB3YWl0aW5nRXh0ZW5zaW9uU2NyaXB0SW5qZWN0aW9uXG4gICAgICA/IGF3YWl0IGludGVydmFsQ2hlY2soMjAsICgpID0+IHRoaXMuX2V4dGVuc2lvbi5pc0F2YWlsYWJsZSgpKVxuICAgICAgOiB0aGlzLl9leHRlbnNpb24uaXNBdmFpbGFibGUoKTtcblxuICAgIHRoaXMuZG9uZUZpcnN0Q2hlY2sgPSB0cnVlO1xuXG4gICAgaWYgKCFpc0V4dGVuc2lvbkluc3RhbGxlZCkge1xuICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLlVOQVZBSUxBQkxFKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBnZXQgbmV0d29ya0luZm8gZnJvbSBleHRlbnNpb25cbiAgICBjb25zdCBpbmZvUGF5bG9hZCA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5pbmZvKCk7XG5cbiAgICBpZiAoXG4gICAgICBpbmZvUGF5bG9hZCAmJlxuICAgICAgdGhpcy5fbmV0d29ya0luZm8uZ2V0VmFsdWUoKS5jaGFpbklEICE9PSBpbmZvUGF5bG9hZC5jaGFpbklEXG4gICAgKSB7XG4gICAgICB0aGlzLl9uZXR3b3JrSW5mby5uZXh0KGluZm9QYXlsb2FkKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLmVuYWJsZVdhbGxldENvbm5lY3Rpb24pIHtcbiAgICAgIGNvbnN0IHN0b3JhZ2VTdG9yZWRXYWxsZXRBZGRyZXNzOiBzdHJpbmcgfCBudWxsID0gZ2V0U3RvcmVkQWRkcmVzcygpO1xuXG4gICAgICAvLyBpZiB0aGUgc3RvcmFnZSBoYXMgd2FsbGV0IGFkZHJlc3NcbiAgICAgIGlmIChcbiAgICAgICAgc3RvcmFnZVN0b3JlZFdhbGxldEFkZHJlc3MgJiZcbiAgICAgICAgQWNjQWRkcmVzcy52YWxpZGF0ZShzdG9yYWdlU3RvcmVkV2FsbGV0QWRkcmVzcylcbiAgICAgICkge1xuICAgICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCk7XG5cbiAgICAgICAgLy8gVE9ETyB0aW1lciBjaGVjaz9cbiAgICAgICAgY29uc3QgY29ubmVjdFJlc3VsdCA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5jb25uZWN0KCk7XG5cbiAgICAgICAgLy8gaWYgYWRkcmVzcyBvZiBleHRlbnNpb24gaXMgbm90IHNhbWUgd2l0aCB0aGUgYWRkcmVzcyBvZiBsb2NhbFN0b3JhZ2VcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGNvbm5lY3RSZXN1bHQuYWRkcmVzcyAmJlxuICAgICAgICAgIEFjY0FkZHJlc3MudmFsaWRhdGUoY29ubmVjdFJlc3VsdC5hZGRyZXNzKVxuICAgICAgICApIHtcbiAgICAgICAgICBzdG9yZUFkZHJlc3MoY29ubmVjdFJlc3VsdC5hZGRyZXNzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIWNvbm5lY3RSZXN1bHQuYWRkcmVzcykge1xuICAgICAgICAgIGlmICh0aGlzLl90ZXJyYUFkZHJlc3MuZ2V0VmFsdWUoKSAhPT0gY29ubmVjdFJlc3VsdC5hZGRyZXNzKSB7XG4gICAgICAgICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChjb25uZWN0UmVzdWx0LmFkZHJlc3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjbGVhclN0b3JlKCk7XG4gICAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVEKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHN0b3JhZ2VTdG9yZWRXYWxsZXRBZGRyZXNzKSB7XG4gICAgICAgICAgY2xlYXJTdG9yZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVEKTtcbiAgICAgICAgdGhpcy5fdGVycmFBZGRyZXNzLm5leHQobnVsbCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChudWxsKTtcbiAgICB9XG4gIH07XG5cbiAgY29ubmVjdCA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uY29ubmVjdCgpO1xuXG4gICAgaWYgKHJlc3VsdD8uYWRkcmVzcykge1xuICAgICAgY29uc3Qgd2FsbGV0QWRkcmVzczogc3RyaW5nID0gcmVzdWx0LmFkZHJlc3M7XG4gICAgICBzdG9yZUFkZHJlc3Mod2FsbGV0QWRkcmVzcyk7XG5cbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0Py5hZGRyZXNzID8/IGZhbHNlO1xuICB9O1xuXG4gIGRpc2Nvbm5lY3QgPSAoKSA9PiB7XG4gICAgY2xlYXJTdG9yZSgpO1xuICAgIHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgfTtcblxuICByZWNoZWNrU3RhdHVzID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5fZXh0ZW5zaW9uLmluVHJhbnNhY3Rpb25Qcm9ncmVzcygpKSB7XG4gICAgICB0aGlzLmNoZWNrU3RhdHVzKGZhbHNlKTtcbiAgICB9XG4gIH07XG5cbiAgcG9zdCA9IDxTZW5kRGF0YSBleHRlbmRzIHt9LCBQYXlsb2FkIGV4dGVuZHMge30+KFxuICAgIGRhdGE6IFNlbmREYXRhLFxuICApOiBQcm9taXNlPHsgbmFtZTogc3RyaW5nOyBwYXlsb2FkOiBQYXlsb2FkIH0+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fZXh0ZW5zaW9uLnBvc3QoZGF0YSk7XG4gIH07XG5cbiAgc2lnbiA9IDxTZW5kRGF0YSBleHRlbmRzIHt9LCBQYXlsb2FkIGV4dGVuZHMge30+KFxuICAgIGRhdGE6IFNlbmREYXRhLFxuICApOiBQcm9taXNlPHsgbmFtZTogc3RyaW5nOyBwYXlsb2FkOiBQYXlsb2FkIH0+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fZXh0ZW5zaW9uLnNpZ24oZGF0YSk7XG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGludGVydmFsQ2hlY2soXG4gIGNvdW50OiBudW1iZXIsXG4gIGZuOiAoKSA9PiBib29sZWFuLFxuICBpbnRlcnZhbE1zOiBudW1iZXIgPSA1MDAsXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgbGV0IGk6IG51bWJlciA9IC0xO1xuICB3aGlsZSAoKytpIDwgY291bnQpIHtcbiAgICBpZiAoZm4oKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIGludGVydmFsTXMpKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG4iXX0=