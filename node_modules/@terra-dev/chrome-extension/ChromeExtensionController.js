import { isDesktopChrome } from '@terra-dev/browser-check';
import { AccAddress, Extension } from '@terra-money/terra.js';
import { BehaviorSubject } from 'rxjs';
import { extensionFixer } from './extensionFixer';
import { clearStore, getStoredAddress, storeAddress } from './storage';
import { ChromeExtensionStatus } from './types';
export class ChromeExtensionController {
    constructor(options) {
        this.options = options;
        this.doneFirstCheck = false;
        this.status = () => {
            return this._status.asObservable();
        };
        this.networkInfo = () => {
            return this._networkInfo.asObservable();
        };
        this.terraAddress = () => {
            return this._terraAddress.asObservable();
        };
        this.checkStatus = async (waitingExtensionScriptInjection = false) => {
            // do not check if browser isn't a chrome
            if (!this.isDesktopChrome) {
                return;
            }
            // ignore the checks before first check done
            // first check -------------------------------â†’ done
            // --------------- second check (ignore)
            if (!waitingExtensionScriptInjection && !this.doneFirstCheck) {
                return;
            }
            // check the extension installed
            const isExtensionInstalled = waitingExtensionScriptInjection
                ? await intervalCheck(20, () => this._extension.isAvailable())
                : this._extension.isAvailable();
            this.doneFirstCheck = true;
            if (!isExtensionInstalled) {
                this._status.next(ChromeExtensionStatus.UNAVAILABLE);
                return;
            }
            // get networkInfo from extension
            const infoPayload = await this._extension.info();
            if (infoPayload &&
                this._networkInfo.getValue().chainID !== infoPayload.chainID) {
                this._networkInfo.next(infoPayload);
            }
            if (this.options.enableWalletConnection) {
                const storageStoredWalletAddress = getStoredAddress();
                // if the storage has wallet address
                if (storageStoredWalletAddress &&
                    AccAddress.validate(storageStoredWalletAddress)) {
                    this._status.next(ChromeExtensionStatus.WALLET_CONNECTED);
                    // TODO timer check?
                    const connectResult = await this._extension.connect();
                    // if address of extension is not same with the address of localStorage
                    if (connectResult.address &&
                        AccAddress.validate(connectResult.address)) {
                        storeAddress(connectResult.address);
                    }
                    if (!!connectResult.address) {
                        if (this._terraAddress.getValue() !== connectResult.address) {
                            this._terraAddress.next(connectResult.address);
                        }
                    }
                    else {
                        clearStore();
                        this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    }
                }
                else {
                    if (storageStoredWalletAddress) {
                        clearStore();
                    }
                    this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    this._terraAddress.next(null);
                }
            }
            else {
                this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                this._terraAddress.next(null);
            }
        };
        this.connect = async () => {
            var _a;
            const result = await this._extension.connect();
            if (result === null || result === void 0 ? void 0 : result.address) {
                const walletAddress = result.address;
                storeAddress(walletAddress);
                await this.checkStatus();
            }
            return (_a = result === null || result === void 0 ? void 0 : result.address) !== null && _a !== void 0 ? _a : false;
        };
        this.disconnect = () => {
            clearStore();
            this.checkStatus();
        };
        this.recheckStatus = () => {
            if (!this._extension.inTransactionProgress()) {
                this.checkStatus(false);
            }
        };
        this.post = (data) => {
            return this._extension.post(data);
        };
        this.sign = (data) => {
            return this._extension.sign(data);
        };
        this.isDesktopChrome =
            typeof window !== 'undefined' &&
                isDesktopChrome(options.dangerously__chromeExtensionCompatibleBrowserCheck(navigator.userAgent));
        this._status = new BehaviorSubject(this.isDesktopChrome
            ? ChromeExtensionStatus.INITIALIZING
            : ChromeExtensionStatus.UNAVAILABLE);
        this._networkInfo = new BehaviorSubject(options.defaultNetwork);
        this._terraAddress = new BehaviorSubject(getStoredAddress());
        this._extension = extensionFixer(new Extension());
        if (this.isDesktopChrome) {
            this.checkStatus(true);
        }
    }
}
async function intervalCheck(count, fn, intervalMs = 500) {
    let i = -1;
    while (++i < count) {
        if (fn()) {
            return true;
        }
        await new Promise((resolve) => setTimeout(resolve, intervalMs));
    }
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9AdGVycmEtZGV2L2Nocm9tZS1leHRlbnNpb24vQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFM0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxjQUFjLEVBQWtCLE1BQU0sa0JBQWtCLENBQUM7QUFDbEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdkUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBVWhELE1BQU0sT0FBTyx5QkFBeUI7SUFTcEMsWUFBcUIsT0FBeUM7UUFBekMsWUFBTyxHQUFQLE9BQU8sQ0FBa0M7UUFIdEQsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUErQi9CLFdBQU0sR0FBRyxHQUFHLEVBQUU7WUFDWixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDckMsQ0FBQyxDQUFDO1FBRUYsZ0JBQVcsR0FBRyxHQUFHLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzFDLENBQUMsQ0FBQztRQUVGLGlCQUFZLEdBQUcsR0FBRyxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzQyxDQUFDLENBQUM7UUFFRixnQkFBVyxHQUFHLEtBQUssRUFBRSxrQ0FBMkMsS0FBSyxFQUFFLEVBQUU7WUFDdkUseUNBQXlDO1lBQ3pDLElBQUksQ0FBQyxJQUFJ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Q0FDaEMsSUFBSSxDQUFDLGVBQWU7WUFDbEIsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLFlBQVk7WUFDcEMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLFdBQVcsQ0FDdEMsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxlQUFlLENBQ3JDLE9BQU8sQ0FBQyxjQUFjLENBQ3ZCLENBQUM7UUFFRixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksZUFBZSxDQUFnQixnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFFNUUsSUFBSSxDQUFDLFVBQVUsR0FBRyxjQUFjLENBQUMsSUFBSSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRWxELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztDQStIRjtBQUVELEtBQUssVUFBVSxhQUFhLENBQzFCLEtBQWEsRUFDYixFQUFpQixFQUNqQixhQUFxQixHQUFHO0lBRXhCLElBQUksQ0FBQyxHQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ25CLE9BQU8sRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFO1FBQ2xCLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDUixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0tBQ2pFO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNEZXNrdG9wQ2hyb21lIH0gZnJvbSAnQHRlcnJhLWRldi9icm93c2VyLWNoZWNrJztcbmltcG9ydCB7IE5ldHdvcmtJbmZvIH0gZnJvbSAnQHRlcnJhLWRldi93YWxsZXQtdHlwZXMnO1xuaW1wb3J0IHsgQWNjQWRkcmVzcywgRXh0ZW5zaW9uIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3RlcnJhLmpzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZXh0ZW5zaW9uRml4ZXIsIEZpeGVkRXh0ZW5zaW9uIH0gZnJvbSAnLi9leHRlbnNpb25GaXhlcic7XG5pbXBvcnQgeyBjbGVhclN0b3JlLCBnZXRTdG9yZWRBZGRyZXNzLCBzdG9yZUFkZHJlc3MgfSBmcm9tICcuL3N0b3JhZ2UnO1xuaW1wb3J0IHsgQ2hyb21lRXh0ZW5zaW9uU3RhdHVzIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlck9wdGlvbnMge1xuICBkZWZhdWx0TmV0d29yazogTmV0d29ya0luZm87XG4gIGVuYWJsZVdhbGxldENvbm5lY3Rpb246IGJvb2xlYW47XG4gIGRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrOiAoXG4gICAgdXNlckFnZW50OiBzdHJpbmcsXG4gICkgPT4gYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXIge1xuICByZWFkb25seSBfc3RhdHVzOiBCZWhhdmlvclN1YmplY3Q8Q2hyb21lRXh0ZW5zaW9uU3RhdHVzPjtcbiAgcmVhZG9ubHkgX25ldHdvcmtJbmZvOiBCZWhhdmlvclN1YmplY3Q8TmV0d29ya0luZm8+O1xuICByZWFkb25seSBfdGVycmFBZGRyZXNzOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD47XG4gIHJlYWRvbmx5IF9leHRlbnNpb246IEZpeGVkRXh0ZW5zaW9uO1xuXG4gIHByaXZhdGUgZG9uZUZpcnN0Q2hlY2sgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWFkb25seSBpc0Rlc2t0b3BDaHJvbWU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgb3B0aW9uczogQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlck9wdGlvbnMpIHtcbiAgICB0aGlzLmlzRGVza3RvcENocm9tZSA9XG4gICAgICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgaXNEZXNrdG9wQ2hyb21lKFxuICAgICAgICBvcHRpb25zLmRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrKFxuICAgICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnQsXG4gICAgICAgICksXG4gICAgICApO1xuXG4gICAgdGhpcy5fc3RhdHVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDaHJvbWVFeHRlbnNpb25TdGF0dXM+KFxuICAgICAgdGhpcy5pc0Rlc2t0b3BDaHJvbWVcbiAgICAgICAgPyBDaHJvbWVFeHRlbnNpb25TdGF0dXMuSU5JVElBTElaSU5HXG4gICAgICAgIDogQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLlVOQVZBSUxBQkxFLFxuICAgICk7XG5cbiAgICB0aGlzLl9uZXR3b3JrSW5mbyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmV0d29ya0luZm8+KFxuICAgICAgb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICApO1xuXG4gICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihnZXRTdG9yZWRBZGRyZXNzKCkpO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uID0gZXh0ZW5zaW9uRml4ZXIobmV3IEV4dGVuc2lvbigpKTtcblxuICAgIGlmICh0aGlzLmlzRGVza3RvcENocm9tZSkge1xuICAgICAgdGhpcy5jaGVja1N0YXR1cyh0cnVlKTtcbiAgICB9XG4gIH1cblxuICBzdGF0dXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXR1cy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBuZXR3b3JrSW5mbyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fbmV0d29ya0luZm8uYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgdGVycmFBZGRyZXNzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl90ZXJyYUFkZHJlc3MuYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgY2hlY2tTdGF0dXMgPSBhc3luYyAod2FpdGluZ0V4dGVuc2lvblNjcmlwdEluamVjdGlvbjogYm9vbGVhbiA9IGZhbHNlKSA9PiB7XG4gICAgLy8gZG8gbm90IGNoZWNrIGlmIGJyb3dzZXIgaXNuJ3QgYSBjaHJvbWVcbiAgICBpZiAoIXRoaXMuaXNEZXNrdG9wQ2hyb21lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaWdub3JlIHRoZSBjaGVja3MgYmVmb3JlIGZpcnN0IGNoZWNrIGRvbmVcbiAgICAvLyBmaXJzdCBjaGVjayAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t4oaSIGRvbmVcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0gc2Vjb25kIGNoZWNrIChpZ25vcmUpXG4gICAgaWYgKCF3YWl0aW5nRXh0ZW5zaW9uU2NyaXB0SW5qZWN0aW9uICYmICF0aGlzLmRvbmVGaXJzdENoZWNrKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgdGhlIGV4dGVuc2lvbiBpbnN0YWxsZWRcbiAgICBjb25zdCBpc0V4dGVuc2lvbkluc3RhbGxlZCA9IHdhaXRpbmdFeHRlbnNpb25TY3JpcHRJbmplY3Rpb25cbiAgICAgID8gYXdhaXQgaW50ZXJ2YWxDaGVjaygyMCwgKCkgPT4gdGhpcy5fZXh0ZW5zaW9uLmlzQXZhaWxhYmxlKCkpXG4gICAgICA6IHRoaXMuX2V4dGVuc2lvbi5pc0F2YWlsYWJsZSgpO1xuXG4gICAgdGhpcy5kb25lRmlyc3RDaGVjayA9IHRydWU7XG5cbiAgICBpZiAoIWlzRXh0ZW5zaW9uSW5zdGFsbGVkKSB7XG4gICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuVU5BVkFJTEFCTEUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGdldCBuZXR3b3JrSW5mbyBmcm9tIGV4dGVuc2lvblxuICAgIGNvbnN0IGluZm9QYXlsb2FkID0gYXdhaXQgdGhpcy5fZXh0ZW5zaW9uLmluZm8oKTtcblxuICAgIGlmIChcbiAgICAgIGluZm9QYXlsb2FkICYmXG4gICAgICB0aGlzLl9uZXR3b3JrSW5mby5nZXRWYWx1ZSgpLmNoYWluSUQgIT09IGluZm9QYXlsb2FkLmNoYWluSURcbiAgICApIHtcbiAgICAgIHRoaXMuX25ldHdvcmtJbmZvLm5leHQoaW5mb1BheWxvYWQpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdGlvbnMuZW5hYmxlV2FsbGV0Q29ubmVjdGlvbikge1xuICAgICAgY29uc3Qgc3RvcmFnZVN0b3JlZFdhbGxldEFkZHJlc3M6IHN0cmluZyB8IG51bGwgPSBnZXRTdG9yZWRBZGRyZXNzKCk7XG5cbiAgICAgIC8vIGlmIHRoZSBzdG9yYWdlIGhhcyB3YWxsZXQgYWRkcmVzc1xuICAgICAgaWYgKFxuICAgICAgICBzdG9yYWdlU3RvcmVkV2FsbGV0QWRkcmVzcyAmJlxuICAgICAgICBBY2NBZGRyZXNzLnZhbGlkYXRlKHN0b3JhZ2VTdG9yZWRXYWxsZXRBZGRyZXNzKVxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEKTtcblxuICAgICAgICAvLyBUT0RPIHRpbWVyIGNoZWNrP1xuICAgICAgICBjb25zdCBjb25uZWN0UmVzdWx0ID0gYXdhaXQgdGhpcy5fZXh0ZW5zaW9uLmNvbm5lY3QoKTtcblxuICAgICAgICAvLyBpZiBhZGRyZXNzIG9mIGV4dGVuc2lvbiBpcyBub3Qgc2FtZSB3aXRoIHRoZSBhZGRyZXNzIG9mIGxvY2FsU3RvcmFnZVxuICAgICAgICBpZiAoXG4gICAgICAgICAgY29ubmVjdFJlc3VsdC5hZGRyZXNzICYmXG4gICAgICAgICAgQWNjQWRkcmVzcy52YWxpZGF0ZShjb25uZWN0UmVzdWx0LmFkZHJlc3MpXG4gICAgICAgICkge1xuICAgICAgICAgIHN0b3JlQWRkcmVzcyhjb25uZWN0UmVzdWx0LmFkZHJlc3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEhY29ubmVjdFJlc3VsdC5hZGRyZXNzKSB7XG4gICAgICAgICAgaWYgKHRoaXMuX3RlcnJhQWRkcmVzcy5nZXRWYWx1ZSgpICE9PSBjb25uZWN0UmVzdWx0LmFkZHJlc3MpIHtcbiAgICAgICAgICAgIHRoaXMuX3RlcnJhQWRkcmVzcy5uZXh0KGNvbm5lY3RSZXN1bHQuYWRkcmVzcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNsZWFyU3RvcmUoKTtcbiAgICAgICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoc3RvcmFnZVN0b3JlZFdhbGxldEFkZHJlc3MpIHtcbiAgICAgICAgICBjbGVhclN0b3JlKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChudWxsKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVEKTtcbiAgICAgIHRoaXMuX3RlcnJhQWRkcmVzcy5uZXh0KG51bGwpO1xuICAgIH1cbiAgfTtcblxuICBjb25uZWN0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5jb25uZWN0KCk7XG5cbiAgICBpZiAocmVzdWx0Py5hZGRyZXNzKSB7XG4gICAgICBjb25zdCB3YWxsZXRBZGRyZXNzOiBzdHJpbmcgPSByZXN1bHQuYWRkcmVzcztcbiAgICAgIHN0b3JlQWRkcmVzcyh3YWxsZXRBZGRyZXNzKTtcblxuICAgICAgYXdhaXQgdGhpcy5jaGVja1N0YXR1cygpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ/LmFkZHJlc3MgPz8gZmFsc2U7XG4gIH07XG5cbiAgZGlzY29ubmVjdCA9ICgpID0+IHtcbiAgICBjbGVhclN0b3JlKCk7XG4gICAgdGhpcy5jaGVja1N0YXR1cygpO1xuICB9O1xuXG4gIHJlY2hlY2tTdGF0dXMgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLl9leHRlbnNpb24uaW5UcmFuc2FjdGlvblByb2dyZXNzKCkpIHtcbiAgICAgIHRoaXMuY2hlY2tTdGF0dXMoZmFsc2UpO1xuICAgIH1cbiAgfTtcblxuICBwb3N0ID0gPFNlbmREYXRhIGV4dGVuZHMge30sIFBheWxvYWQgZXh0ZW5kcyB7fT4oXG4gICAgZGF0YTogU2VuZERhdGEsXG4gICk6IFByb21pc2U8eyBuYW1lOiBzdHJpbmc7IHBheWxvYWQ6IFBheWxvYWQgfT4gPT4ge1xuICAgIHJldHVybiB0aGlzLl9leHRlbnNpb24ucG9zdChkYXRhKTtcbiAgfTtcblxuICBzaWduID0gPFNlbmREYXRhIGV4dGVuZHMge30sIFBheWxvYWQgZXh0ZW5kcyB7fT4oXG4gICAgZGF0YTogU2VuZERhdGEsXG4gICk6IFByb21pc2U8eyBuYW1lOiBzdHJpbmc7IHBheWxvYWQ6IFBheWxvYWQgfT4gPT4ge1xuICAgIHJldHVybiB0aGlzLl9leHRlbnNpb24uc2lnbihkYXRhKTtcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW50ZXJ2YWxDaGVjayhcbiAgY291bnQ6IG51bWJlcixcbiAgZm46ICgpID0+IGJvb2xlYW4sXG4gIGludGVydmFsTXM6IG51bWJlciA9IDUwMCxcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBsZXQgaTogbnVtYmVyID0gLTE7XG4gIHdoaWxlICgrK2kgPCBjb3VudCkge1xuICAgIGlmIChmbigpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgaW50ZXJ2YWxNcykpO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cbiJdfQ==