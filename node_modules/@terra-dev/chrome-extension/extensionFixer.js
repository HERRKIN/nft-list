import { UserDenied } from '@terra-dev/wallet-types';
import { ChromeExtensionCreateTxFailed, ChromeExtensionTxFailed, ChromeExtensionUnspecifiedError, } from './errors';
function toExplicitError(error) {
    if (error && 'code' in error) {
        switch (error.code) {
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L182
            case 1:
                return new UserDenied();
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L137
            case 2:
                if (error.data) {
                    const { txhash } = error.data;
                    return new ChromeExtensionTxFailed(txhash, error.message);
                }
                else {
                    return new ChromeExtensionTxFailed(undefined, error.message);
                }
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L153
            case 3:
                return new ChromeExtensionCreateTxFailed(error.message);
            default:
                return new ChromeExtensionUnspecifiedError(error.message);
        }
    }
    else {
        return new ChromeExtensionUnspecifiedError();
    }
}
export function extensionFixer(extension) {
    let _inTransactionProgress = false;
    const postResolvers = new Map();
    const signResolvers = new Map();
    const infoResolvers = new Set();
    const connectResolvers = new Set();
    extension.on('onPost', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!postResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = postResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onPost', payload });
        }
        postResolvers.delete(payload.id);
        if (postResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onSign', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!signResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = signResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onSign', payload });
        }
        signResolvers.delete(payload.id);
        if (signResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onInfo', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of infoResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        infoResolvers.clear();
    });
    extension.on('onConnect', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of connectResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        connectResolvers.clear();
    });
    function post(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.post({
                ...data,
                purgeQueue: true,
            });
            postResolvers.set(id, resolver);
            setTimeout(() => {
                if (postResolvers.has(id)) {
                    postResolvers.delete(id);
                    if (postResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function sign(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.sign({
                ...data,
                purgeQueue: true,
            });
            signResolvers.set(id, resolver);
            setTimeout(() => {
                if (signResolvers.has(id)) {
                    signResolvers.delete(id);
                    if (signResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function connect() {
        return new Promise((...resolver) => {
            connectResolvers.add(resolver);
            extension.connect();
        });
    }
    function info() {
        return new Promise((...resolver) => {
            infoResolvers.add(resolver);
            extension.info();
        });
    }
    function isAvailable() {
        return extension.isAvailable;
    }
    function inTransactionProgress() {
        return _inTransactionProgress;
    }
    return {
        post,
        sign,
        connect,
        info,
        isAvailable,
        inTransactionProgress,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uRml4ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQHRlcnJhLWRldi9jaHJvbWUtZXh0ZW5zaW9uL2V4dGVuc2lvbkZpeGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBZSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVsRSxPQUFPLEVBQ0wsNkJBQTZCLEVBQzdCLHVCQUF1QixFQUN2QiwrQkFBK0IsR0FDaEMsTUFBTSxVQUFVLENBQUM7QUFnQmxCLFNBQVMsZUFBZSxDQUFDLEtBQVU7SUFDakMsSUFBSSxLQUFLLElBQUksTUFBTSxJQUFJLEtBQUssRUFBRTtRQUM1QixRQUFRLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDbEIseUZBQXlGO1lBQ3pGLEtBQUssQ0FBQztnQkFDSixPQUFPLElBQUksVUFBVSxFQUFFLENBQUM7WUFDMUIseUZBQXlGO1lBQ3pGLEtBQUssQ0FBQztnQkFDSixJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7b0JBQ2QsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7b0JBQzlCLE9BQU8sSUFBSSx1QkFBdUIsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUMzRDtxQkFBTTtvQkFDTCxPQUFPLElBQUksdUJBQXVCLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDOUQ7WUFDSCx5RkFBeUY7WUFDekYsS0FBSyxDQUFDO2dCQUNKLE9BQU8sSUFBSSw2QkFBNkIsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDMUQ7Z0JBQ0UsT0FBTyxJQUFJLCtCQUErQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM3RDtLQUNGO1NBQU07UUFDTCxPQUFPLElBQUksK0JBQStCLEVBQUUsQ0FBQztLQUM5QztBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUs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SUFDL0IsQ0FBQztJQUVELFNBQVMscUJBQXFCO1FBQzVCLE9BQU8sc0JBQXNCLENBQUM7SUFDaEMsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJO1FBQ0osSUFBSTtRQUNKLE9BQU87UUFDUCxJQUFJO1FBQ0osV0FBVztRQUNYLHFCQUFxQjtLQUN0QixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5ldHdvcmtJbmZvLCBVc2VyRGVuaWVkIH0gZnJvbSAnQHRlcnJhLWRldi93YWxsZXQtdHlwZXMnO1xuaW1wb3J0IHsgRXh0ZW5zaW9uIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3RlcnJhLmpzJztcbmltcG9ydCB7XG4gIENocm9tZUV4dGVuc2lvbkNyZWF0ZVR4RmFpbGVkLFxuICBDaHJvbWVFeHRlbnNpb25UeEZhaWxlZCxcbiAgQ2hyb21lRXh0ZW5zaW9uVW5zcGVjaWZpZWRFcnJvcixcbn0gZnJvbSAnLi9lcnJvcnMnO1xuXG50eXBlIENvbm5lY3RSZXNwb25zZSA9IHsgYWRkcmVzcz86IHN0cmluZyB9O1xudHlwZSBQb3N0UmVzcG9uc2UgPSBhbnk7XG50eXBlIFNpZ25SZXNwb25zZSA9IGFueTtcbnR5cGUgSW5mb1Jlc3BvbnNlID0gTmV0d29ya0luZm87XG5cbmV4cG9ydCBpbnRlcmZhY2UgRml4ZWRFeHRlbnNpb24ge1xuICBpc0F2YWlsYWJsZTogKCkgPT4gYm9vbGVhbjtcbiAgcG9zdDogKGRhdGE6IG9iamVjdCkgPT4gUHJvbWlzZTxQb3N0UmVzcG9uc2U+O1xuICBzaWduOiAoZGF0YTogb2JqZWN0KSA9PiBQcm9taXNlPFNpZ25SZXNwb25zZT47XG4gIGluZm86ICgpID0+IFByb21pc2U8SW5mb1Jlc3BvbnNlPjtcbiAgY29ubmVjdDogKCkgPT4gUHJvbWlzZTxDb25uZWN0UmVzcG9uc2U+O1xuICBpblRyYW5zYWN0aW9uUHJvZ3Jlc3M6ICgpID0+IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIHRvRXhwbGljaXRFcnJvcihlcnJvcjogYW55KSB7XG4gIGlmIChlcnJvciAmJiAnY29kZScgaW4gZXJyb3IpIHtcbiAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHtcbiAgICAgIC8vIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3RlcnJhLXByb2plY3Qvc3RhdGlvbi9ibG9iL21haW4vc3JjL2V4dGVuc2lvbi9Db25maXJtLnRzeCNMMTgyXG4gICAgICBjYXNlIDE6XG4gICAgICAgIHJldHVybiBuZXcgVXNlckRlbmllZCgpO1xuICAgICAgLy8gQHNlZSBodHRwczovL2dpdGh1Yi5jb20vdGVycmEtcHJvamVjdC9zdGF0aW9uL2Jsb2IvbWFpbi9zcmMvZXh0ZW5zaW9uL0NvbmZpcm0udHN4I0wxMzdcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgaWYgKGVycm9yLmRhdGEpIHtcbiAgICAgICAgICBjb25zdCB7IHR4aGFzaCB9ID0gZXJyb3IuZGF0YTtcbiAgICAgICAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvblR4RmFpbGVkKHR4aGFzaCwgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25UeEZhaWxlZCh1bmRlZmluZWQsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAvLyBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS90ZXJyYS1wcm9qZWN0L3N0YXRpb24vYmxvYi9tYWluL3NyYy9leHRlbnNpb24vQ29uZmlybS50c3gjTDE1M1xuICAgICAgY2FzZSAzOlxuICAgICAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvbkNyZWF0ZVR4RmFpbGVkKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25VbnNwZWNpZmllZEVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvblVuc3BlY2lmaWVkRXJyb3IoKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0ZW5zaW9uRml4ZXIoZXh0ZW5zaW9uOiBFeHRlbnNpb24pOiBGaXhlZEV4dGVuc2lvbiB7XG4gIGxldCBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gZmFsc2U7XG5cbiAgY29uc3QgcG9zdFJlc29sdmVycyA9IG5ldyBNYXA8XG4gICAgbnVtYmVyLFxuICAgIFsoZGF0YTogYW55KSA9PiB2b2lkLCAoZXJyb3I6IGFueSkgPT4gdm9pZF1cbiAgPigpO1xuXG4gIGNvbnN0IHNpZ25SZXNvbHZlcnMgPSBuZXcgTWFwPFxuICAgIG51bWJlcixcbiAgICBbKGRhdGE6IGFueSkgPT4gdm9pZCwgKGVycm9yOiBhbnkpID0+IHZvaWRdXG4gID4oKTtcblxuICBjb25zdCBpbmZvUmVzb2x2ZXJzID0gbmV3IFNldDxbKGRhdGE6IGFueSkgPT4gdm9pZCwgKGVycm9yOiBhbnkpID0+IHZvaWRdPigpO1xuXG4gIGNvbnN0IGNvbm5lY3RSZXNvbHZlcnMgPSBuZXcgU2V0PFxuICAgIFsoZGF0YTogYW55KSA9PiB2b2lkLCAoZXJyb3I6IGFueSkgPT4gdm9pZF1cbiAgPigpO1xuXG4gIGV4dGVuc2lvbi5vbignb25Qb3N0JywgKHJlc3VsdCkgPT4ge1xuICAgIGlmICghcmVzdWx0KSByZXR1cm47XG5cbiAgICBjb25zdCB7IGVycm9yLCAuLi5wYXlsb2FkIH0gPSByZXN1bHQ7XG5cbiAgICBpZiAoIXBvc3RSZXNvbHZlcnMuaGFzKHBheWxvYWQuaWQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgW3Jlc29sdmUsIHJlamVjdF0gPSBwb3N0UmVzb2x2ZXJzLmdldChwYXlsb2FkLmlkKSE7XG5cbiAgICBpZiAoIXBheWxvYWQuc3VjY2Vzcykge1xuICAgICAgcmVqZWN0KHRvRXhwbGljaXRFcnJvcihlcnJvcikpO1xuICAgIH0gZWxzZSBpZiAocmVzb2x2ZSkge1xuICAgICAgcmVzb2x2ZSh7IG5hbWU6ICdvblBvc3QnLCBwYXlsb2FkIH0pO1xuICAgIH1cblxuICAgIHBvc3RSZXNvbHZlcnMuZGVsZXRlKHBheWxvYWQuaWQpO1xuXG4gICAgaWYgKHBvc3RSZXNvbHZlcnMuc2l6ZSA9PT0gMCkge1xuICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIH1cbiAgfSk7XG5cbiAgZXh0ZW5zaW9uLm9uKCdvblNpZ24nLCAocmVzdWx0KSA9PiB7XG4gICAgaWYgKCFyZXN1bHQpIHJldHVybjtcblxuICAgIGNvbnN0IHsgZXJyb3IsIC4uLnBheWxvYWQgfSA9IHJlc3VsdDtcblxuICAgIGlmICghc2lnblJlc29sdmVycy5oYXMocGF5bG9hZC5pZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBbcmVzb2x2ZSwgcmVqZWN0XSA9IHNpZ25SZXNvbHZlcnMuZ2V0KHBheWxvYWQuaWQpITtcblxuICAgIGlmICghcGF5bG9hZC5zdWNjZXNzKSB7XG4gICAgICByZWplY3QodG9FeHBsaWNpdEVycm9yKGVycm9yKSk7XG4gICAgfSBlbHNlIGlmIChyZXNvbHZlKSB7XG4gICAgICByZXNvbHZlKHsgbmFtZTogJ29uU2lnbicsIHBheWxvYWQgfSk7XG4gICAgfVxuXG4gICAgc2lnblJlc29sdmVycy5kZWxldGUocGF5bG9hZC5pZCk7XG5cbiAgICBpZiAoc2lnblJlc29sdmVycy5zaXplID09PSAwKSB7XG4gICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gZmFsc2U7XG4gICAgfVxuICB9KTtcblxuICBleHRlbnNpb24ub24oJ29uSW5mbycsIChyZXN1bHQpID0+IHtcbiAgICBpZiAoIXJlc3VsdCkgcmV0dXJuO1xuICAgIGNvbnN0IHsgZXJyb3IsIC4uLnBheWxvYWQgfSA9IHJlc3VsdDtcblxuICAgIGZvciAoY29uc3QgW3Jlc29sdmUsIHJlamVjdF0gb2YgaW5mb1Jlc29sdmVycykge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKHBheWxvYWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGluZm9SZXNvbHZlcnMuY2xlYXIoKTtcbiAgfSk7XG5cbiAgZXh0ZW5zaW9uLm9uKCdvbkNvbm5lY3QnLCAocmVzdWx0KSA9PiB7XG4gICAgaWYgKCFyZXN1bHQpIHJldHVybjtcbiAgICBjb25zdCB7IGVycm9yLCAuLi5wYXlsb2FkIH0gPSByZXN1bHQ7XG5cbiAgICBmb3IgKGNvbnN0IFtyZXNvbHZlLCByZWplY3RdIG9mIGNvbm5lY3RSZXNvbHZlcnMpIHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZShwYXlsb2FkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25uZWN0UmVzb2x2ZXJzLmNsZWFyKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIHBvc3QoZGF0YTogb2JqZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFBvc3RSZXNwb25zZT4oKC4uLnJlc29sdmVyKSA9PiB7XG4gICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gdHJ1ZTtcblxuICAgICAgY29uc3QgaWQgPSBleHRlbnNpb24ucG9zdCh7XG4gICAgICAgIC4uLihkYXRhIGFzIGFueSksXG4gICAgICAgIHB1cmdlUXVldWU6IHRydWUsXG4gICAgICB9KTtcblxuICAgICAgcG9zdFJlc29sdmVycy5zZXQoaWQsIHJlc29sdmVyKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChwb3N0UmVzb2x2ZXJzLmhhcyhpZCkpIHtcbiAgICAgICAgICBwb3N0UmVzb2x2ZXJzLmRlbGV0ZShpZCk7XG5cbiAgICAgICAgICBpZiAocG9zdFJlc29sdmVycy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LCAxMDAwICogMTIwKTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNpZ24oZGF0YTogb2JqZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFNpZ25SZXNwb25zZT4oKC4uLnJlc29sdmVyKSA9PiB7XG4gICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gdHJ1ZTtcblxuICAgICAgY29uc3QgaWQgPSBleHRlbnNpb24uc2lnbih7XG4gICAgICAgIC4uLihkYXRhIGFzIGFueSksXG4gICAgICAgIHB1cmdlUXVldWU6IHRydWUsXG4gICAgICB9KTtcblxuICAgICAgc2lnblJlc29sdmVycy5zZXQoaWQsIHJlc29sdmVyKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChzaWduUmVzb2x2ZXJzLmhhcyhpZCkpIHtcbiAgICAgICAgICBzaWduUmVzb2x2ZXJzLmRlbGV0ZShpZCk7XG5cbiAgICAgICAgICBpZiAoc2lnblJlc29sdmVycy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LCAxMDAwICogMTIwKTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNvbm5lY3QoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPENvbm5lY3RSZXNwb25zZT4oKC4uLnJlc29sdmVyKSA9PiB7XG4gICAgICBjb25uZWN0UmVzb2x2ZXJzLmFkZChyZXNvbHZlcik7XG4gICAgICBleHRlbnNpb24uY29ubmVjdCgpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gaW5mbygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8SW5mb1Jlc3BvbnNlPigoLi4ucmVzb2x2ZXIpID0+IHtcbiAgICAgIGluZm9SZXNvbHZlcnMuYWRkKHJlc29sdmVyKTtcbiAgICAgIGV4dGVuc2lvbi5pbmZvKCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBpc0F2YWlsYWJsZSgpIHtcbiAgICByZXR1cm4gZXh0ZW5zaW9uLmlzQXZhaWxhYmxlO1xuICB9XG5cbiAgZnVuY3Rpb24gaW5UcmFuc2FjdGlvblByb2dyZXNzKCkge1xuICAgIHJldHVybiBfaW5UcmFuc2FjdGlvblByb2dyZXNzO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBwb3N0LFxuICAgIHNpZ24sXG4gICAgY29ubmVjdCxcbiAgICBpbmZvLFxuICAgIGlzQXZhaWxhYmxlLFxuICAgIGluVHJhbnNhY3Rpb25Qcm9ncmVzcyxcbiAgfTtcbn1cbiJdfQ==