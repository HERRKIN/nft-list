"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.connect = exports.connectIfSessionExists = void 0;
const browser_check_1 = require("@terra-dev/browser-check");
const walletconnect_qrcode_modal_1 = require("@terra-dev/walletconnect-qrcode-modal");
const core_1 = __importDefault(require("@walletconnect/core"));
const cryptoLib = __importStar(require("@walletconnect/iso-crypto"));
const utils_1 = require("@walletconnect/utils");
const rxjs_1 = require("rxjs");
const errors_1 = require("./errors");
const socket_transport_1 = __importDefault(require("./impl/socket-transport"));
const types_1 = require("./types");
const WALLETCONNECT_STORAGE_KEY = 'walletconnect';
function connectIfSessionExists(options = {}) {
    const storedSession = localStorage.getItem(WALLETCONNECT_STORAGE_KEY);
    if (typeof storedSession === 'string') {
        return connect(options, true);
    }
    return null;
}
exports.connectIfSessionExists = connectIfSessionExists;
function connect(options = {}, useCachedSession = false) {
    var _a, _b;
    let connector = null;
    let sessionSubject = new rxjs_1.BehaviorSubject({
        status: types_1.WalletConnectSessionStatus.DISCONNECTED,
    });
    const qrcodeModal = (_b = (_a = options.connectorOpts) === null || _a === void 0 ? void 0 : _a.qrcodeModal) !== null && _b !== void 0 ? _b : new walletconnect_qrcode_modal_1.TerraWalletconnectQrcodeModal();
    const connectorOpts = {
        bridge: 'https://walletconnect.terra.dev/',
        qrcodeModal,
        ...options.connectorOpts,
    };
    const pushServerOpts = options.pushServerOpts;
    // ---------------------------------------------
    // event listeners
    // ---------------------------------------------
    function initEvents() {
        if (!connector) {
            throw new Error(`WalletConnect is not defined!`);
        }
        connector.on('session_update', async (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.CONNECTED,
                peerMeta: payload.params[0],
                terraAddress: payload.params[0].accounts[0],
                chainId: payload.params[0].chainId,
            });
            console.log('WALLETCONNECT SESSION UPDATED:', payload.params[0]);
        });
        connector.on('connect', (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.CONNECTED,
                peerMeta: payload.params[0],
                terraAddress: payload.params[0].accounts[0],
                chainId: payload.params[0].chainId,
            });
        });
        connector.on('disconnect', (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.DISCONNECTED,
            });
        });
    }
    // ---------------------------------------------
    // initialize
    // ---------------------------------------------
    const cachedSession = localStorage.getItem('walletconnect');
    if (typeof cachedSession === 'string' && useCachedSession) {
        const cachedSessionObject = JSON.parse(cachedSession);
        const clientId = cachedSessionObject.clientId;
        const draftConnector = new core_1.default({
            connectorOpts: {
                ...connectorOpts,
                session: JSON.parse(cachedSession),
            },
            pushServerOpts,
            cryptoLib,
            transport: new socket_transport_1.default({
                protocol: 'wc',
                version: 1,
                url: connectorOpts.bridge,
                subscriptions: [clientId],
            }),
        });
        draftConnector.clientId = clientId;
        connector = draftConnector;
        initEvents();
        sessionSubject.next({
            status: types_1.WalletConnectSessionStatus.CONNECTED,
            peerMeta: draftConnector.peerMeta,
            terraAddress: draftConnector.accounts[0],
            chainId: draftConnector.chainId,
        });
    }
    else {
        const clientId = utils_1.uuid();
        const draftConnector = new core_1.default({
            connectorOpts,
            pushServerOpts,
            cryptoLib,
            transport: new socket_transport_1.default({
                protocol: 'wc',
                version: 1,
                url: connectorOpts.bridge,
                subscriptions: [clientId],
            }),
        });
        draftConnector.clientId = clientId;
        connector = draftConnector;
        if (!draftConnector.connected) {
            draftConnector.createSession().catch(console.error);
            if (qrcodeModal instanceof walletconnect_qrcode_modal_1.TerraWalletconnectQrcodeModal) {
                qrcodeModal.setCloseCallback(() => {
                    sessionSubject.next({
                        status: types_1.WalletConnectSessionStatus.DISCONNECTED,
                    });
                });
            }
            initEvents();
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.REQUESTED,
            });
        }
    }
    // ---------------------------------------------
    // methods
    // ---------------------------------------------
    function disconnect() {
        if (connector && connector.connected) {
            try {
                connector.killSession();
            }
            catch (_a) { }
        }
        sessionSubject.next({
            status: types_1.WalletConnectSessionStatus.DISCONNECTED,
        });
    }
    function session() {
        return sessionSubject.asObservable();
    }
    function getLatestSession() {
        return sessionSubject.getValue();
    }
    /**
     * post transaction
     *
     * @param tx transaction data
     * @throws { WalletConnectUserDenied }
     * @throws { WalletConnectCreateTxFailed }
     * @throws { WalletConnectTxFailed }
     * @throws { WalletConnectTimeout }
     * @throws { WalletConnectTxUnspecifiedError }
     */
    function post(tx) {
        var _a, _b, _c;
        if (!connector || !connector.connected) {
            throw new Error(`WalletConnect is not connected!`);
        }
        const id = Date.now();
        const serializedTxOptions = {
            msgs: tx.msgs.map((msg) => msg.toJSON()),
            fee: (_a = tx.fee) === null || _a === void 0 ? void 0 : _a.toJSON(),
            memo: tx.memo,
            gasPrices: (_b = tx.gasPrices) === null || _b === void 0 ? void 0 : _b.toString(),
            gasAdjustment: (_c = tx.gasAdjustment) === null || _c === void 0 ? void 0 : _c.toString(),
            account_number: tx.account_number,
            sequence: tx.sequence,
            feeDenoms: tx.feeDenoms,
        };
        if (browser_check_1.isMobile()) {
            const payload = btoa(JSON.stringify({
                id,
                handshakeTopic: connector.handshakeTopic,
                params: serializedTxOptions,
            }));
            // FIXME changed walletconnect confirm schema
            window.location.href = `terrastation://walletconnect_confirm/?payload=${payload}`;
            //window.location.href = `terrastation://wallet_connect_confirm?id=${id}&handshakeTopic=${
            //  connector.handshakeTopic
            //}&params=${JSON.stringify([serializedTxOptions])}`;
        }
        return connector
            .sendCustomRequest({
            id,
            method: 'post',
            params: [serializedTxOptions],
        })
            .catch((error) => {
            let throwError = error;
            try {
                const { code, txhash, message, raw_message } = JSON.parse(error.message);
                switch (code) {
                    case 1:
                        throwError = new errors_1.WalletConnectUserDenied();
                        break;
                    case 2:
                        throwError = new errors_1.WalletConnectCreateTxFailed(message);
                        break;
                    case 3:
                        throwError = new errors_1.WalletConnectTxFailed(txhash, message, raw_message);
                        break;
                    case 4:
                        throwError = new errors_1.WalletConnectTimeout(message);
                        break;
                    case 99:
                        throwError = new errors_1.WalletConnectTxUnspecifiedError(message);
                        break;
                }
            }
            catch (_a) {
                throwError = new errors_1.WalletConnectTxUnspecifiedError(error.message);
            }
            throw throwError;
        });
    }
    // ---------------------------------------------
    // return
    // ---------------------------------------------
    return {
        session,
        getLatestSession,
        post,
        disconnect,
    };
}
exports.connect = connect;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9AdGVycmEtZGV2L3dhbGxldGNvbm5lY3QvY29ubmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsNERBQW9EO0FBQ3BELHNGQUFzRjtBQUV0RiwrREFBNEM7QUFDNUMscUVBQXVEO0FBS3ZELGdEQUE0QztBQUM1QywrQkFBbUQ7QUFDbkQscUNBTWtCO0FBQ2xCLCtFQUFzRDtBQUN0RCxtQ0FJaUI7QUErQmpCLE1BQU0seUJBQXlCLEdBQUcsZUFBZSxDQUFDO0FBRWxELFNBQWdCLHNCQUFzQixDQUNwQyxVQUEwQyxFQUFFO0lBRTVDLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUV0RSxJQUFJLE9BQU8sYUFBYSxLQUFLLFFBQVEsRUFBRTtRQUNyQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDL0I7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFWRCx3REFVQztBQUVELFNBQWdCLE9BQU8sQ0FDckIsVUFBMEMsRUFBRSxFQUM1QyxtQkFBNEIsS0FBSzs7SUFFakMsSUFBSSxTQUFTLEdBQXFCLElBQUksQ0FBQztJQUV2QyxJQUFJLGNBQWMsR0FDaEIsSUFBSSxzQkFBZSxDQUF1QjtRQUN4QyxNQUFNLEVBQUUsa0NBQTBCLENBQUMsWUFBWTtLQUNoRCxDQUFDLENBQUM7SUFFTCxNQUFNLFdBQVcsR0FDZixNQUFBLE1BQUEsT0FBTyxDQUFDLGFBQWEsMENBQUUsV0FBVyxtQ0FBSSxJQUFJLDBEQUE2QixFQUFFLENBQUM7SUFFNUUsTUFBTSxhQUFhLEdBQTBCO1FBQzNDLE1BQU0sRUFBRSxrQ0FBa0M7UUFDMUMsV0FBVztRQUNYLEdBQUcsT0FBTyxDQUFDLGFBQWE7S0FDekIsQ0FBQztJQUVGLE1BQU0sY0FBYyxH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LENBQUM7d0JBQ0YsTUFBTTtvQkFDUixLQUFLLENBQUM7d0JBQ0osVUFBVSxHQUFHLElBQUksNkJBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQy9DLE1BQU07b0JBQ1IsS0FBSyxFQUFFO3dCQUNMLFVBQVUsR0FBRyxJQUFJLHdDQUErQixDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUMxRCxNQUFNO2lCQUNUO2FBQ0Y7WUFBQyxXQUFNO2dCQUNOLFVBQVUsR0FBRyxJQUFJLHdDQUErQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNqRTtZQUVELE1BQU0sVUFBVSxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELGdEQUFnRDtJQUNoRCxTQUFTO0lBQ1QsZ0RBQWdEO0lBQ2hELE9BQU87UUFDTCxPQUFPO1FBQ1AsZ0JBQWdCO1FBQ2hCLElBQUk7UUFDSixVQUFVO0tBQ1gsQ0FBQztBQUNKLENBQUM7QUEzUEQsMEJBMlBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNNb2JpbGUgfSBmcm9tICdAdGVycmEtZGV2L2Jyb3dzZXItY2hlY2snO1xuaW1wb3J0IHsgVGVycmFXYWxsZXRjb25uZWN0UXJjb2RlTW9kYWwgfSBmcm9tICdAdGVycmEtZGV2L3dhbGxldGNvbm5lY3QtcXJjb2RlLW1vZGFsJztcbmltcG9ydCB7IENyZWF0ZVR4T3B0aW9ucyB9IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5pbXBvcnQgQ29ubmVjdG9yIGZyb20gJ0B3YWxsZXRjb25uZWN0L2NvcmUnO1xuaW1wb3J0ICogYXMgY3J5cHRvTGliIGZyb20gJ0B3YWxsZXRjb25uZWN0L2lzby1jcnlwdG8nO1xuaW1wb3J0IHtcbiAgSVB1c2hTZXJ2ZXJPcHRpb25zLFxuICBJV2FsbGV0Q29ubmVjdE9wdGlvbnMsXG59IGZyb20gJ0B3YWxsZXRjb25uZWN0L3R5cGVzJztcbmltcG9ydCB7IHV1aWQgfSBmcm9tICdAd2FsbGV0Y29ubmVjdC91dGlscyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIFdhbGxldENvbm5lY3RDcmVhdGVUeEZhaWxlZCxcbiAgV2FsbGV0Q29ubmVjdFRpbWVvdXQsXG4gIFdhbGxldENvbm5lY3RUeEZhaWxlZCxcbiAgV2FsbGV0Q29ubmVjdFR4VW5zcGVjaWZpZWRFcnJvcixcbiAgV2FsbGV0Q29ubmVjdFVzZXJEZW5pZWQsXG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCBTb2NrZXRUcmFuc3BvcnQgZnJvbSAnLi9pbXBsL3NvY2tldC10cmFuc3BvcnQnO1xuaW1wb3J0IHtcbiAgV2FsbGV0Q29ubmVjdFNlc3Npb24sXG4gIFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLFxuICBXYWxsZXRDb25uZWN0VHhSZXN1bHQsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBDb25maWd1cmF0aW9uIHBhcmFtZXRlciB0aGF0IGBuZXcgV2FsbGV0Q29ubmVjdChjb25uZWN0b3JPcHRzKWBcbiAgICpcbiAgICogQGRlZmF1bHRcbiAgICogYGBganNcbiAgICoge1xuICAgKiAgIGJyaWRnZTogJ2h0dHBzOi8vd2FsbGV0Y29ubmVjdC50ZXJyYS5kZXYvJyxcbiAgICogICBxcmNvZGVNb2RhbDogbmV3IFRlcnJhV2FsbGV0Y29ubmVjdFFyY29kZU1vZGFsKCksXG4gICAqIH1cbiAgICogYGBgXG4gICAqL1xuICBjb25uZWN0b3JPcHRzPzogSVdhbGxldENvbm5lY3RPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBDb25maWd1cmF0aW9uIHBhcmFtZXRlciB0aGF0IGBuZXcgV2FsbGV0Q29ubmVjdChfLCBwdXNoU2VydmVyT3B0cylgXG4gICAqXG4gICAqIEBkZWZhdWx0IHVuZGVmaW5lZFxuICAgKi9cbiAgcHVzaFNlcnZlck9wdHM/OiBJUHVzaFNlcnZlck9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIge1xuICBzZXNzaW9uOiAoKSA9PiBPYnNlcnZhYmxlPFdhbGxldENvbm5lY3RTZXNzaW9uPjtcbiAgZ2V0TGF0ZXN0U2Vzc2lvbjogKCkgPT4gV2FsbGV0Q29ubmVjdFNlc3Npb247XG4gIHBvc3Q6ICh0eDogQ3JlYXRlVHhPcHRpb25zKSA9PiBQcm9taXNlPFdhbGxldENvbm5lY3RUeFJlc3VsdD47XG4gIGRpc2Nvbm5lY3Q6ICgpID0+IHZvaWQ7XG59XG5cbmNvbnN0IFdBTExFVENPTk5FQ1RfU1RPUkFHRV9LRVkgPSAnd2FsbGV0Y29ubmVjdCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25uZWN0SWZTZXNzaW9uRXhpc3RzKFxuICBvcHRpb25zOiBXYWxsZXRDb25uZWN0Q29udHJvbGxlck9wdGlvbnMgPSB7fSxcbik6IFdhbGxldENvbm5lY3RDb250cm9sbGVyIHwgbnVsbCB7XG4gIGNvbnN0IHN0b3JlZFNlc3Npb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShXQUxMRVRDT05ORUNUX1NUT1JBR0VfS0VZKTtcblxuICBpZiAodHlwZW9mIHN0b3JlZFNlc3Npb24gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIGNvbm5lY3Qob3B0aW9ucywgdHJ1ZSk7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbm5lY3QoXG4gIG9wdGlvbnM6IFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyA9IHt9LFxuICB1c2VDYWNoZWRTZXNzaW9uOiBib29sZWFuID0gZmFsc2UsXG4pOiBXYWxsZXRDb25uZWN0Q29udHJvbGxlciB7XG4gIGxldCBjb25uZWN0b3I6IENvbm5lY3RvciB8IG51bGwgPSBudWxsO1xuXG4gIGxldCBzZXNzaW9uU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PFdhbGxldENvbm5lY3RTZXNzaW9uPiA9XG4gICAgbmV3IEJlaGF2aW9yU3ViamVjdDxXYWxsZXRDb25uZWN0U2Vzc2lvbj4oe1xuICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5ESVNDT05ORUNURUQsXG4gICAgfSk7XG5cbiAgY29uc3QgcXJjb2RlTW9kYWwgPVxuICAgIG9wdGlvbnMuY29ubmVjdG9yT3B0cz8ucXJjb2RlTW9kYWwgPz8gbmV3IFRlcnJhV2FsbGV0Y29ubmVjdFFyY29kZU1vZGFsKCk7XG5cbiAgY29uc3QgY29ubmVjdG9yT3B0czogSVdhbGxldENvbm5lY3RPcHRpb25zID0ge1xuICAgIGJyaWRnZTogJ2h0dHBzOi8vd2FsbGV0Y29ubmVjdC50ZXJyYS5kZXYvJyxcbiAgICBxcmNvZGVNb2RhbCxcbiAgICAuLi5vcHRpb25zLmNvbm5lY3Rvck9wdHMsXG4gIH07XG5cbiAgY29uc3QgcHVzaFNlcnZlck9wdHM6IElQdXNoU2VydmVyT3B0aW9ucyB8IHVuZGVmaW5lZCA9IG9wdGlvbnMucHVzaFNlcnZlck9wdHM7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGV2ZW50IGxpc3RlbmVyc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgZnVuY3Rpb24gaW5pdEV2ZW50cygpIHtcbiAgICBpZiAoIWNvbm5lY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBXYWxsZXRDb25uZWN0IGlzIG5vdCBkZWZpbmVkIWApO1xuICAgIH1cblxuICAgIGNvbm5lY3Rvci5vbignc2Vzc2lvbl91cGRhdGUnLCBhc3luYyAoZXJyb3IsIHBheWxvYWQpID0+IHtcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG5cbiAgICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkNPTk5FQ1RFRCxcbiAgICAgICAgcGVlck1ldGE6IHBheWxvYWQucGFyYW1zWzBdLFxuICAgICAgICB0ZXJyYUFkZHJlc3M6IHBheWxvYWQucGFyYW1zWzBdLmFjY291bnRzWzBdLFxuICAgICAgICBjaGFpbklkOiBwYXlsb2FkLnBhcmFtc1swXS5jaGFpbklkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKCdXQUxMRVRDT05ORUNUIFNFU1NJT04gVVBEQVRFRDonLCBwYXlsb2FkLnBhcmFtc1swXSk7XG4gICAgfSk7XG5cbiAgICBjb25uZWN0b3Iub24oJ2Nvbm5lY3QnLCAoZXJyb3IsIHBheWxvYWQpID0+IHtcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG5cbiAgICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkNPTk5FQ1RFRCxcbiAgICAgICAgcGVlck1ldGE6IHBheWxvYWQucGFyYW1zWzBdLFxuICAgICAgICB0ZXJyYUFkZHJlc3M6IHBheWxvYWQucGFyYW1zWzBdLmFjY291bnRzWzBdLFxuICAgICAgICBjaGFpbklkOiBwYXlsb2FkLnBhcmFtc1swXS5jaGFpbklkLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBjb25uZWN0b3Iub24oJ2Rpc2Nvbm5lY3QnLCAoZXJyb3IsIHBheWxvYWQpID0+IHtcbiAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG5cbiAgICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkRJU0NPTk5FQ1RFRCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGluaXRpYWxpemVcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGNvbnN0IGNhY2hlZFNlc3Npb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnd2FsbGV0Y29ubmVjdCcpO1xuXG4gIGlmICh0eXBlb2YgY2FjaGVkU2Vzc2lvbiA9PT0gJ3N0cmluZycgJiYgdXNlQ2FjaGVkU2Vzc2lvbikge1xuICAgIGNvbnN0IGNhY2hlZFNlc3Npb25PYmplY3QgPSBKU09OLnBhcnNlKGNhY2hlZFNlc3Npb24pO1xuICAgIGNvbnN0IGNsaWVudElkID0gY2FjaGVkU2Vzc2lvbk9iamVjdC5jbGllbnRJZDtcbiAgICBjb25zdCBkcmFmdENvbm5lY3RvciA9IG5ldyBDb25uZWN0b3Ioe1xuICAgICAgY29ubmVjdG9yT3B0czoge1xuICAgICAgICAuLi5jb25uZWN0b3JPcHRzLFxuICAgICAgICBzZXNzaW9uOiBKU09OLnBhcnNlKGNhY2hlZFNlc3Npb24pLFxuICAgICAgfSxcbiAgICAgIHB1c2hTZXJ2ZXJPcHRzLFxuICAgICAgY3J5cHRvTGliLFxuICAgICAgdHJhbnNwb3J0OiBuZXcgU29ja2V0VHJhbnNwb3J0KHtcbiAgICAgICAgcHJvdG9jb2w6ICd3YycsXG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIHVybDogY29ubmVjdG9yT3B0cy5icmlkZ2UhLFxuICAgICAgICBzdWJzY3JpcHRpb25zOiBbY2xpZW50SWRdLFxuICAgICAgfSksXG4gICAgfSk7XG4gICAgZHJhZnRDb25uZWN0b3IuY2xpZW50SWQgPSBjbGllbnRJZDtcblxuICAgIGNvbm5lY3RvciA9IGRyYWZ0Q29ubmVjdG9yO1xuXG4gICAgaW5pdEV2ZW50cygpO1xuXG4gICAgc2Vzc2lvblN1YmplY3QubmV4dCh7XG4gICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkNPTk5FQ1RFRCxcbiAgICAgIHBlZXJNZXRhOiBkcmFmdENvbm5lY3Rvci5wZWVyTWV0YSEsXG4gICAgICB0ZXJyYUFkZHJlc3M6IGRyYWZ0Q29ubmVjdG9yLmFjY291bnRzWzBdLFxuICAgICAgY2hhaW5JZDogZHJhZnRDb25uZWN0b3IuY2hhaW5JZCxcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBjbGllbnRJZCA9IHV1aWQoKTtcbiAgICBjb25zdCBkcmFmdENvbm5lY3RvciA9IG5ldyBDb25uZWN0b3Ioe1xuICAgICAgY29ubmVjdG9yT3B0cyxcbiAgICAgIHB1c2hTZXJ2ZXJPcHRzLFxuICAgICAgY3J5cHRvTGliLFxuICAgICAgdHJhbnNwb3J0OiBuZXcgU29ja2V0VHJhbnNwb3J0KHtcbiAgICAgICAgcHJvdG9jb2w6ICd3YycsXG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIHVybDogY29ubmVjdG9yT3B0cy5icmlkZ2UhLFxuICAgICAgICBzdWJzY3JpcHRpb25zOiBbY2xpZW50SWRdLFxuICAgICAgfSksXG4gICAgfSk7XG4gICAgZHJhZnRDb25uZWN0b3IuY2xpZW50SWQgPSBjbGllbnRJZDtcblxuICAgIGNvbm5lY3RvciA9IGRyYWZ0Q29ubmVjdG9yO1xuXG4gICAgaWYgKCFkcmFmdENvbm5lY3Rvci5jb25uZWN0ZWQpIHtcbiAgICAgIGRyYWZ0Q29ubmVjdG9yLmNyZWF0ZVNlc3Npb24oKS5jYXRjaChjb25zb2xlLmVycm9yKTtcblxuICAgICAgaWYgKHFyY29kZU1vZGFsIGluc3RhbmNlb2YgVGVycmFXYWxsZXRjb25uZWN0UXJjb2RlTW9kYWwpIHtcbiAgICAgICAgcXJjb2RlTW9kYWwuc2V0Q2xvc2VDYWxsYmFjaygoKSA9PiB7XG4gICAgICAgICAgc2Vzc2lvblN1YmplY3QubmV4dCh7XG4gICAgICAgICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkRJU0NPTk5FQ1RFRCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGluaXRFdmVudHMoKTtcblxuICAgICAgc2Vzc2lvblN1YmplY3QubmV4dCh7XG4gICAgICAgIHN0YXR1czogV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMuUkVRVUVTVEVELFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIG1ldGhvZHNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGZ1bmN0aW9uIGRpc2Nvbm5lY3QoKSB7XG4gICAgaWYgKGNvbm5lY3RvciAmJiBjb25uZWN0b3IuY29ubmVjdGVkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25uZWN0b3Iua2lsbFNlc3Npb24oKTtcbiAgICAgIH0gY2F0Y2gge31cbiAgICB9XG5cbiAgICBzZXNzaW9uU3ViamVjdC5uZXh0KHtcbiAgICAgIHN0YXR1czogV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMuRElTQ09OTkVDVEVELFxuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gc2Vzc2lvbigpOiBPYnNlcnZhYmxlPFdhbGxldENvbm5lY3RTZXNzaW9uPiB7XG4gICAgcmV0dXJuIHNlc3Npb25TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0TGF0ZXN0U2Vzc2lvbigpOiBXYWxsZXRDb25uZWN0U2Vzc2lvbiB7XG4gICAgcmV0dXJuIHNlc3Npb25TdWJqZWN0LmdldFZhbHVlKCk7XG4gIH1cblxuICAvKipcbiAgICogcG9zdCB0cmFuc2FjdGlvblxuICAgKlxuICAgKiBAcGFyYW0gdHggdHJhbnNhY3Rpb24gZGF0YVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFVzZXJEZW5pZWQgfVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdENyZWF0ZVR4RmFpbGVkIH1cbiAgICogQHRocm93cyB7IFdhbGxldENvbm5lY3RUeEZhaWxlZCB9XG4gICAqIEB0aHJvd3MgeyBXYWxsZXRDb25uZWN0VGltZW91dCB9XG4gICAqIEB0aHJvd3MgeyBXYWxsZXRDb25uZWN0VHhVbnNwZWNpZmllZEVycm9yIH1cbiAgICovXG4gIGZ1bmN0aW9uIHBvc3QodHg6IENyZWF0ZVR4T3B0aW9ucyk6IFByb21pc2U8V2FsbGV0Q29ubmVjdFR4UmVzdWx0PiB7XG4gICAgaWYgKCFjb25uZWN0b3IgfHwgIWNvbm5lY3Rvci5jb25uZWN0ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgV2FsbGV0Q29ubmVjdCBpcyBub3QgY29ubmVjdGVkIWApO1xuICAgIH1cblxuICAgIGNvbnN0IGlkID0gRGF0ZS5ub3coKTtcblxuICAgIGNvbnN0IHNlcmlhbGl6ZWRUeE9wdGlvbnMgPSB7XG4gICAgICBtc2dzOiB0eC5tc2dzLm1hcCgobXNnKSA9PiBtc2cudG9KU09OKCkpLFxuICAgICAgZmVlOiB0eC5mZWU/LnRvSlNPTigpLFxuICAgICAgbWVtbzogdHgubWVtbyxcbiAgICAgIGdhc1ByaWNlczogdHguZ2FzUHJpY2VzPy50b1N0cmluZygpLFxuICAgICAgZ2FzQWRqdXN0bWVudDogdHguZ2FzQWRqdXN0bWVudD8udG9TdHJpbmcoKSxcbiAgICAgIGFjY291bnRfbnVtYmVyOiB0eC5hY2NvdW50X251bWJlcixcbiAgICAgIHNlcXVlbmNlOiB0eC5zZXF1ZW5jZSxcbiAgICAgIGZlZURlbm9tczogdHguZmVlRGVub21zLFxuICAgIH07XG5cbiAgICBpZiAoaXNNb2JpbGUoKSkge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGJ0b2EoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBoYW5kc2hha2VUb3BpYzogY29ubmVjdG9yLmhhbmRzaGFrZVRvcGljLFxuICAgICAgICAgIHBhcmFtczogc2VyaWFsaXplZFR4T3B0aW9ucyxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICAvLyBGSVhNRSBjaGFuZ2VkIHdhbGxldGNvbm5lY3QgY29uZmlybSBzY2hlbWFcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gYHRlcnJhc3RhdGlvbjovL3dhbGxldGNvbm5lY3RfY29uZmlybS8/cGF5bG9hZD0ke3BheWxvYWR9YDtcbiAgICAgIC8vd2luZG93LmxvY2F0aW9uLmhyZWYgPSBgdGVycmFzdGF0aW9uOi8vd2FsbGV0X2Nvbm5lY3RfY29uZmlybT9pZD0ke2lkfSZoYW5kc2hha2VUb3BpYz0ke1xuICAgICAgLy8gIGNvbm5lY3Rvci5oYW5kc2hha2VUb3BpY1xuICAgICAgLy99JnBhcmFtcz0ke0pTT04uc3RyaW5naWZ5KFtzZXJpYWxpemVkVHhPcHRpb25zXSl9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29ubmVjdG9yXG4gICAgICAuc2VuZEN1c3RvbVJlcXVlc3Qoe1xuICAgICAgICBpZCxcbiAgICAgICAgbWV0aG9kOiAncG9zdCcsXG4gICAgICAgIHBhcmFtczogW3NlcmlhbGl6ZWRUeE9wdGlvbnNdLFxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgbGV0IHRocm93RXJyb3IgPSBlcnJvcjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHsgY29kZSwgdHhoYXNoLCBtZXNzYWdlLCByYXdfbWVzc2FnZSB9ID0gSlNPTi5wYXJzZShcbiAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VXNlckRlbmllZCgpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0Q3JlYXRlVHhGYWlsZWQobWVzc2FnZSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAzOlxuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFdhbGxldENvbm5lY3RUeEZhaWxlZChcbiAgICAgICAgICAgICAgICB0eGhhc2gsXG4gICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICByYXdfbWVzc2FnZSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDQ6XG4gICAgICAgICAgICAgIHRocm93RXJyb3IgPSBuZXcgV2FsbGV0Q29ubmVjdFRpbWVvdXQobWVzc2FnZSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSA5OTpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VHhVbnNwZWNpZmllZEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIHRocm93RXJyb3IgPSBuZXcgV2FsbGV0Q29ubmVjdFR4VW5zcGVjaWZpZWRFcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IHRocm93RXJyb3I7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyByZXR1cm5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJldHVybiB7XG4gICAgc2Vzc2lvbixcbiAgICBnZXRMYXRlc3RTZXNzaW9uLFxuICAgIHBvc3QsXG4gICAgZGlzY29ubmVjdCxcbiAgfTtcbn1cbiJdfQ==