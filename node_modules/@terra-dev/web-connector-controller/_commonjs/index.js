"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebConnectorController = void 0;
const web_connector_interface_1 = require("@terra-dev/web-connector-interface");
const bowser_1 = __importDefault(require("bowser"));
const rxjs_1 = require("rxjs");
async function getConnector(hostWindow) {
    return new Promise((resolve) => {
        let count = 20;
        function task() {
            if (--count > 0) {
                if (typeof hostWindow.terraWebConnectors !== 'undefined' &&
                    Array.isArray(hostWindow.terraWebConnectors) &&
                    hostWindow.terraWebConnectors.length > 0) {
                    console.log(`TerraWebConnector: `, JSON.stringify(hostWindow.terraWebConnectors[0].getInfo()));
                    resolve(hostWindow.terraWebConnectors[0]);
                }
                else {
                    console.warn(`Can't find window.terraWebConnectors. wait 500ms...`);
                    setTimeout(task, 500);
                }
            }
            else {
                resolve(undefined);
            }
        }
        task();
    });
}
class WebConnectorController {
    constructor(hostWindow) {
        this.hostWindow = hostWindow;
        this._connector = null;
        /**
         * Refetch the clientsStates
         *
         * You don't need call this method in most cases.
         * Normally, when the clientStates is changed, states() get the new clientStates.
         *
         * @example
         * client.states()
         *       .subscribe(states => {
         *         // 2. will get new clientStates
         *         console.log('Got new states', Date.now())
         *       })
         *
         * function callback() {
         *   // 1. refetch client states
         *   client.refetchStates()
         * }
         */
        this.refetchStates = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.refetchStates();
        };
        /**
         * Request approval connection to the Extension. (Connect)
         */
        this.requestApproval = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.requestApproval();
        };
        this.status = () => {
            return this._status.asObservable();
        };
        this.getLastStatus = () => {
            return this._status.getValue();
        };
        /**
         * Execute transaction
         *
         * @example
         * client.post(terraAddress, tx: CreateTxOptions)
         *       .subscribe({
         *          next: (result: WebConnectorTxProgress | WebConnectorTxSucceed) => {
         *            switch (result.status) {
         *              case WebConnectorTxStatus.PROGRESS:
         *                console.log('in progress', result.payload)
         *                break;
         *              case WebConnectorTxStatus.SUCCEED:
         *                console.log('succeed', result.payload)
         *                break;
         *            }
         *          },
         *          error: (error) => {
         *            if (error instanceof WebConnectorUserDenied) {
         *              console.log('user denied')
         *            } else if (error instanceof WebConnectorCreateTxFailed) {
         *              console.log('create tx failed', error.message)
         *            } else if (error instanceof WebConnectorTxFailed) {
         *              console.log('tx failed', error.txhash, error.message, error.raw_message)
         *            } else {
         *              console.log('unspecified error', 'message' in error ? error.message : String(error))
         *            }
         *          }
         *       })
         *
         * @description The stream will be
         * TxProgress -> [...TxProgress] -> TxSucceed
         *
         * - Tx is Succeed : TxProgress -> [...TxProgress] -> TxSucceed
         */
        this.post = (terraAddress, tx) => {
            return this._connector.post(terraAddress, tx);
        };
        /**
         * Add CW20 Token to extension dashboard
         */
        this.addCW20Tokens = (chainID, ...tokenAddrs) => {
            return this._connector.addCW20Tokens(chainID, ...tokenAddrs);
        };
        this.hasCW20Tokens = (chainID, ...tokenAddrs) => {
            return this._connector.hasCW20Tokens(chainID, ...tokenAddrs);
        };
        /**
         * @example
         * client.states()
         *       .subscribe(states => {
         *         if (!states) {
         *           console.log('client is still not ready')
         *         } else {
         *           console.log('current network is', states.network)
         *           console.log('current wallets are', states.wallets)
         *         }
         *       })
         */
        this.states = () => {
            return this._states.asObservable();
        };
        this.getLastStates = () => {
            return this._states.getValue();
        };
        /**
         * Destroy this client
         *
         * - Unsubscribe all RxJs Subjects (every Observables are stoped)
         */
        this.destroy = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.close();
            this._connector = null;
        };
        this._status = new rxjs_1.BehaviorSubject({
            type: web_connector_interface_1.WebConnectorStatusType.INITIALIZING,
        });
        this._states = new rxjs_1.BehaviorSubject(null);
        const browser = bowser_1.default.getParser(navigator.userAgent);
        //@ts-ignore
        getConnector(hostWindow).then((connector) => {
            if (!connector) {
                const name = browser.getBrowserName(true);
                let installLink;
                switch (name) {
                    case 'chrome':
                    case 'microsoft edge':
                        installLink = 'https://google.com/chrome';
                        break;
                    case 'firefox':
                        installLink = 'https://google.com/firefox';
                        break;
                    case 'safari':
                        installLink = 'https://google.com/safari';
                        break;
                    default:
                        installLink = 'https://google.com/chrome';
                        break;
                }
                this._status.next({
                    type: web_connector_interface_1.WebConnectorStatusType.NO_AVAILABLE,
                    isConnectorExists: false,
                    installLink,
                });
                return;
            }
            if (!connector.checkBrowserAvailability(navigator.userAgent)) {
                this._status.next({
                    type: web_connector_interface_1.WebConnectorStatusType.NO_AVAILABLE,
                    isConnectorExists: true,
                    isSupportBrowser: false,
                });
                return;
            }
            connector.open(hostWindow, this._status, this._states);
            this._connector = connector;
        });
    }
}
exports.WebConnectorController = WebConnectorController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvQHRlcnJhLWRldi93ZWItY29ubmVjdG9yLWNvbnRyb2xsZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0ZBTTRDO0FBRTVDLG9EQUE0QjtBQUM1QiwrQkFBbUQ7QUFFbkQsS0FBSyxVQUFVLFlBQVksQ0FBQyxVQUUzQjtJQUNDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM3QixJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7UUFFZixTQUFTLElBQUk7WUFDWCxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRTtnQkFDZixJQUNFLE9BQU8sVUFBVSxDQUFDLGtCQUFrQixLQUFLLFdBQVc7b0JBQ3BELEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDO29CQUM1QyxVQUFVLENBQUMsa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDeEM7b0JBQ0EsT0FBTyxDQUFDLEdBQUcsQ0FDVCxxQkFBcUIsRUFDckIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FDM0QsQ0FBQztvQkFDRixPQUFPLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzNDO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxJQUFJLENBQUMscURBQXFELENBQUMsQ0FBQztvQkFDcEUsVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztpQkFDdkI7YUFDRjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDcEI7UUFDSCxDQUFDO1FBRUQsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFhLHNCQUFzQjtJ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QyxNQUFNO29CQUNSLEtBQUssUUFBUTt3QkFDWCxXQUFXLEdBQUcsMkJBQTJCLENBQUM7d0JBQzFDLE1BQU07b0JBQ1I7d0JBQ0UsV0FBVyxHQUFHLDJCQUEyQixDQUFDO3dCQUMxQyxNQUFNO2lCQUNUO2dCQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNoQixJQUFJLEVBQUUsZ0RBQXNCLENBQUMsWUFBWTtvQkFDekMsaUJBQWlCLEVBQUUsS0FBSztvQkFDeEIsV0FBVztpQkFDWixDQUFDLENBQUM7Z0JBRUgsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQzVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNoQixJQUFJLEVBQUUsZ0RBQXNCLENBQUMsWUFBWTtvQkFDekMsaUJBQWlCLEVBQUUsSUFBSTtvQkFDdkIsZ0JBQWdCLEVBQUUsS0FBSztpQkFDeEIsQ0FBQyxDQUFDO2dCQUVILE9BQU87YUFDUjtZQUVELFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXZELElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQXdIRjtBQXBMRCx3REFvTEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBUZXJyYVdlYkNvbm5lY3RvcixcbiAgV2ViQ29ubmVjdG9yU3RhdGVzLFxuICBXZWJDb25uZWN0b3JTdGF0dXMsXG4gIFdlYkNvbm5lY3RvclN0YXR1c1R5cGUsXG4gIFdlYkNvbm5lY3RvclR4UmVzdWx0LFxufSBmcm9tICdAdGVycmEtZGV2L3dlYi1jb25uZWN0b3ItaW50ZXJmYWNlJztcbmltcG9ydCB7IENyZWF0ZVR4T3B0aW9ucyB9IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5pbXBvcnQgYm93c2VyIGZyb20gJ2Jvd3Nlcic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q29ubmVjdG9yKGhvc3RXaW5kb3c6IHtcbiAgdGVycmFXZWJDb25uZWN0b3JzOiBUZXJyYVdlYkNvbm5lY3RvcltdIHwgdW5kZWZpbmVkO1xufSk6IFByb21pc2U8VGVycmFXZWJDb25uZWN0b3IgfCB1bmRlZmluZWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgbGV0IGNvdW50ID0gMjA7XG5cbiAgICBmdW5jdGlvbiB0YXNrKCkge1xuICAgICAgaWYgKC0tY291bnQgPiAwKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0eXBlb2YgaG9zdFdpbmRvdy50ZXJyYVdlYkNvbm5lY3RvcnMgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICAgICAgQXJyYXkuaXNBcnJheShob3N0V2luZG93LnRlcnJhV2ViQ29ubmVjdG9ycykgJiZcbiAgICAgICAgICBob3N0V2luZG93LnRlcnJhV2ViQ29ubmVjdG9ycy5sZW5ndGggPiAwXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgYFRlcnJhV2ViQ29ubmVjdG9yOiBgLFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoaG9zdFdpbmRvdy50ZXJyYVdlYkNvbm5lY3RvcnNbMF0uZ2V0SW5mbygpKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHJlc29sdmUoaG9zdFdpbmRvdy50ZXJyYVdlYkNvbm5lY3RvcnNbMF0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihgQ2FuJ3QgZmluZCB3aW5kb3cudGVycmFXZWJDb25uZWN0b3JzLiB3YWl0IDUwMG1zLi4uYCk7XG4gICAgICAgICAgc2V0VGltZW91dCh0YXNrLCA1MDApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGFzaygpO1xuICB9KTtcbn1cblxuZXhwb3J0IGNsYXNzIFdlYkNvbm5lY3RvckNvbnRyb2xsZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IF9zdGF0dXM6IEJlaGF2aW9yU3ViamVjdDxXZWJDb25uZWN0b3JTdGF0dXM+O1xuICBwcml2YXRlIHJlYWRvbmx5IF9zdGF0ZXM6IEJlaGF2aW9yU3ViamVjdDxXZWJDb25uZWN0b3JTdGF0ZXMgfCBudWxsPjtcbiAgcHJpdmF0ZSBfY29ubmVjdG9yOiBUZXJyYVdlYkNvbm5lY3RvciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaG9zdFdpbmRvdzogV2luZG93KSB7XG4gICAgdGhpcy5fc3RhdHVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxXZWJDb25uZWN0b3JTdGF0dXM+KHtcbiAgICAgIHR5cGU6IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuSU5JVElBTElaSU5HLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fc3RhdGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxXZWJDb25uZWN0b3JTdGF0ZXMgfCBudWxsPihudWxsKTtcblxuICAgIGNvbnN0IGJyb3dzZXIgPSBib3dzZXIuZ2V0UGFyc2VyKG5hdmlnYXRvci51c2VyQWdlbnQpO1xuXG4gICAgLy9AdHMtaWdub3JlXG4gICAgZ2V0Q29ubmVjdG9yKGhvc3RXaW5kb3cpLnRoZW4oKGNvbm5lY3RvcikgPT4ge1xuICAgICAgaWYgKCFjb25uZWN0b3IpIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IGJyb3dzZXIuZ2V0QnJvd3Nlck5hbWUodHJ1ZSk7XG5cbiAgICAgICAgbGV0IGluc3RhbGxMaW5rOiBzdHJpbmc7XG5cbiAgICAgICAgc3dpdGNoIChuYW1lKSB7XG4gICAgICAgICAgY2FzZSAnY2hyb21lJzpcbiAgICAgICAgICBjYXNlICdtaWNyb3NvZnQgZWRnZSc6XG4gICAgICAgICAgICBpbnN0YWxsTGluayA9ICdodHRwczovL2dvb2dsZS5jb20vY2hyb21lJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2ZpcmVmb3gnOlxuICAgICAgICAgICAgaW5zdGFsbExpbmsgPSAnaHR0cHM6Ly9nb29nbGUuY29tL2ZpcmVmb3gnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnc2FmYXJpJzpcbiAgICAgICAgICAgIGluc3RhbGxMaW5rID0gJ2h0dHBzOi8vZ29vZ2xlLmNvbS9zYWZhcmknO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIGluc3RhbGxMaW5rID0gJ2h0dHBzOi8vZ29vZ2xlLmNvbS9jaHJvbWUnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9zdGF0dXMubmV4dCh7XG4gICAgICAgICAgdHlwZTogV2ViQ29ubmVjdG9yU3RhdHVzVHlwZS5OT19BVkFJTEFCTEUsXG4gICAgICAgICAgaXNDb25uZWN0b3JFeGlzdHM6IGZhbHNlLFxuICAgICAgICAgIGluc3RhbGxMaW5rLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICghY29ubmVjdG9yLmNoZWNrQnJvd3NlckF2YWlsYWJpbGl0eShuYXZpZ2F0b3IudXNlckFnZW50KSkge1xuICAgICAgICB0aGlzLl9zdGF0dXMubmV4dCh7XG4gICAgICAgICAgdHlwZTogV2ViQ29ubmVjdG9yU3RhdHVzVHlwZS5OT19BVkFJTEFCTEUsXG4gICAgICAgICAgaXNDb25uZWN0b3JFeGlzdHM6IHRydWUsXG4gICAgICAgICAgaXNTdXBwb3J0QnJvd3NlcjogZmFsc2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29ubmVjdG9yLm9wZW4oaG9zdFdpbmRvdywgdGhpcy5fc3RhdHVzLCB0aGlzLl9zdGF0ZXMpO1xuXG4gICAgICB0aGlzLl9jb25uZWN0b3IgPSBjb25uZWN0b3I7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVmZXRjaCB0aGUgY2xpZW50c1N0YXRlc1xuICAgKlxuICAgKiBZb3UgZG9uJ3QgbmVlZCBjYWxsIHRoaXMgbWV0aG9kIGluIG1vc3QgY2FzZXMuXG4gICAqIE5vcm1hbGx5LCB3aGVuIHRoZSBjbGllbnRTdGF0ZXMgaXMgY2hhbmdlZCwgc3RhdGVzKCkgZ2V0IHRoZSBuZXcgY2xpZW50U3RhdGVzLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBjbGllbnQuc3RhdGVzKClcbiAgICogICAgICAgLnN1YnNjcmliZShzdGF0ZXMgPT4ge1xuICAgKiAgICAgICAgIC8vIDIuIHdpbGwgZ2V0IG5ldyBjbGllbnRTdGF0ZXNcbiAgICogICAgICAgICBjb25zb2xlLmxvZygnR290IG5ldyBzdGF0ZXMnLCBEYXRlLm5vdygpKVxuICAgKiAgICAgICB9KVxuICAgKlxuICAgKiBmdW5jdGlvbiBjYWxsYmFjaygpIHtcbiAgICogICAvLyAxLiByZWZldGNoIGNsaWVudCBzdGF0ZXNcbiAgICogICBjbGllbnQucmVmZXRjaFN0YXRlcygpXG4gICAqIH1cbiAgICovXG4gIHJlZmV0Y2hTdGF0ZXMgPSAoKSA9PiB7XG4gICAgdGhpcy5fY29ubmVjdG9yPy5yZWZldGNoU3RhdGVzKCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlcXVlc3QgYXBwcm92YWwgY29ubmVjdGlvbiB0byB0aGUgRXh0ZW5zaW9uLiAoQ29ubmVjdClcbiAgICovXG4gIHJlcXVlc3RBcHByb3ZhbCA9ICgpID0+IHtcbiAgICB0aGlzLl9jb25uZWN0b3I/LnJlcXVlc3RBcHByb3ZhbCgpO1xuICB9O1xuXG4gIHN0YXR1cyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdHVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIGdldExhc3RTdGF0dXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXR1cy5nZXRWYWx1ZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBFeGVjdXRlIHRyYW5zYWN0aW9uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGNsaWVudC5wb3N0KHRlcnJhQWRkcmVzcywgdHg6IENyZWF0ZVR4T3B0aW9ucylcbiAgICogICAgICAgLnN1YnNjcmliZSh7XG4gICAqICAgICAgICAgIG5leHQ6IChyZXN1bHQ6IFdlYkNvbm5lY3RvclR4UHJvZ3Jlc3MgfCBXZWJDb25uZWN0b3JUeFN1Y2NlZWQpID0+IHtcbiAgICogICAgICAgICAgICBzd2l0Y2ggKHJlc3VsdC5zdGF0dXMpIHtcbiAgICogICAgICAgICAgICAgIGNhc2UgV2ViQ29ubmVjdG9yVHhTdGF0dXMuUFJPR1JFU1M6XG4gICAqICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbiBwcm9ncmVzcycsIHJlc3VsdC5wYXlsb2FkKVxuICAgKiAgICAgICAgICAgICAgICBicmVhaztcbiAgICogICAgICAgICAgICAgIGNhc2UgV2ViQ29ubmVjdG9yVHhTdGF0dXMuU1VDQ0VFRDpcbiAgICogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3N1Y2NlZWQnLCByZXN1bHQucGF5bG9hZClcbiAgICogICAgICAgICAgICAgICAgYnJlYWs7XG4gICAqICAgICAgICAgICAgfVxuICAgKiAgICAgICAgICB9LFxuICAgKiAgICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XG4gICAqICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgV2ViQ29ubmVjdG9yVXNlckRlbmllZCkge1xuICAgKiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VzZXIgZGVuaWVkJylcbiAgICogICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgV2ViQ29ubmVjdG9yQ3JlYXRlVHhGYWlsZWQpIHtcbiAgICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjcmVhdGUgdHggZmFpbGVkJywgZXJyb3IubWVzc2FnZSlcbiAgICogICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgV2ViQ29ubmVjdG9yVHhGYWlsZWQpIHtcbiAgICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd0eCBmYWlsZWQnLCBlcnJvci50eGhhc2gsIGVycm9yLm1lc3NhZ2UsIGVycm9yLnJhd19tZXNzYWdlKVxuICAgKiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygndW5zcGVjaWZpZWQgZXJyb3InLCAnbWVzc2FnZScgaW4gZXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSlcbiAgICogICAgICAgICAgICB9XG4gICAqICAgICAgICAgIH1cbiAgICogICAgICAgfSlcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uIFRoZSBzdHJlYW0gd2lsbCBiZVxuICAgKiBUeFByb2dyZXNzIC0+IFsuLi5UeFByb2dyZXNzXSAtPiBUeFN1Y2NlZWRcbiAgICpcbiAgICogLSBUeCBpcyBTdWNjZWVkIDogVHhQcm9ncmVzcyAtPiBbLi4uVHhQcm9ncmVzc10gLT4gVHhTdWNjZWVkXG4gICAqL1xuICBwb3N0ID0gKFxuICAgIHRlcnJhQWRkcmVzczogc3RyaW5nLFxuICAgIHR4OiBDcmVhdGVUeE9wdGlvbnMsXG4gICk6IE9ic2VydmFibGU8V2ViQ29ubmVjdG9yVHhSZXN1bHQ+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yIS5wb3N0KHRlcnJhQWRkcmVzcywgdHgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGQgQ1cyMCBUb2tlbiB0byBleHRlbnNpb24gZGFzaGJvYXJkXG4gICAqL1xuICBhZGRDVzIwVG9rZW5zID0gKGNoYWluSUQ6IHN0cmluZywgLi4udG9rZW5BZGRyczogc3RyaW5nW10pID0+IHtcbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yIS5hZGRDVzIwVG9rZW5zKGNoYWluSUQsIC4uLnRva2VuQWRkcnMpO1xuICB9O1xuXG4gIGhhc0NXMjBUb2tlbnMgPSAoY2hhaW5JRDogc3RyaW5nLCAuLi50b2tlbkFkZHJzOiBzdHJpbmdbXSkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3IhLmhhc0NXMjBUb2tlbnMoY2hhaW5JRCwgLi4udG9rZW5BZGRycyk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBleGFtcGxlXG4gICAqIGNsaWVudC5zdGF0ZXMoKVxuICAgKiAgICAgICAuc3Vic2NyaWJlKHN0YXRlcyA9PiB7XG4gICAqICAgICAgICAgaWYgKCFzdGF0ZXMpIHtcbiAgICogICAgICAgICAgIGNvbnNvbGUubG9nKCdjbGllbnQgaXMgc3RpbGwgbm90IHJlYWR5JylcbiAgICogICAgICAgICB9IGVsc2Uge1xuICAgKiAgICAgICAgICAgY29uc29sZS5sb2coJ2N1cnJlbnQgbmV0d29yayBpcycsIHN0YXRlcy5uZXR3b3JrKVxuICAgKiAgICAgICAgICAgY29uc29sZS5sb2coJ2N1cnJlbnQgd2FsbGV0cyBhcmUnLCBzdGF0ZXMud2FsbGV0cylcbiAgICogICAgICAgICB9XG4gICAqICAgICAgIH0pXG4gICAqL1xuICBzdGF0ZXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlcy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBnZXRMYXN0U3RhdGVzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZXMuZ2V0VmFsdWUoKTtcbiAgfTtcblxuICAvKipcbiAgICogRGVzdHJveSB0aGlzIGNsaWVudFxuICAgKlxuICAgKiAtIFVuc3Vic2NyaWJlIGFsbCBSeEpzIFN1YmplY3RzIChldmVyeSBPYnNlcnZhYmxlcyBhcmUgc3RvcGVkKVxuICAgKi9cbiAgZGVzdHJveSA9ICgpID0+IHtcbiAgICB0aGlzLl9jb25uZWN0b3I/LmNsb3NlKCk7XG4gICAgdGhpcy5fY29ubmVjdG9yID0gbnVsbDtcbiAgfTtcbn1cbiJdfQ==